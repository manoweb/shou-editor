!function(e){"use strict";const t=(e,t=document)=>t.querySelector(e),i=(e,t=document)=>[...t.querySelectorAll(e)];function s(e,t,i,s){e&&("function"==typeof i?e.addEventListener(t,i):e.addEventListener(t,t=>{const o=t.target.closest(i);o&&e.contains(o)&&s.call(o,t,o)}))}const o={en:{"tool.undo":"Undo","tool.redo":"Redo","tool.crop":"Crop","tool.resize":"Resize","tool.rotateLeft":"Rotate left","tool.rotateRight":"Rotate right","tool.flipH":"Flip horizontal","tool.flipV":"Flip vertical","tool.pencil":"Pencil","tool.rect":"Rectangle","tool.circle":"Circle","tool.line":"Line","tool.arrow":"Arrow","tool.text":"Text","tool.eraser":"Eraser","btn.save":"Save","btn.cancel":"Cancel","btn.reset":"Reset","btn.apply":"Apply","filter.brightness":"Brightness","filter.contrast":"Contrast","filter.saturation":"Saturation","filter.blur":"Blur","filter.grayscale":"Grayscale","filter.sepia":"Sepia","filter.hue":"Hue","opt.color":"Color","opt.fill":"Fill","opt.size":"Size","opt.font":"Font","opt.fontSize":"Font size","opt.width":"Width","opt.height":"Height","opt.lockRatio":"Lock ratio","opt.opacity":"Opacity","empty.loadImage":"Drop an image here or click to load","confirm.reset":"Reset to original image?","panel.layers":"Layers","panel.image":"Image","layer.add":"New layer","layer.delete":"Delete layer","layer.duplicate":"Duplicate layer","layer.background":"Background","layer.group":"New group","opt.blendMode":"Blend","tool.move":"Move","tool.pan":"Pan","tool.eyedropper":"Eyedropper","tool.fill":"Fill","tool.gradient":"Gradient","opt.tolerance":"Tolerance","opt.color1":"Color 1","opt.color2":"Color 2","opt.align":"Align","tool.selectRect":"Rectangle select","tool.selectEllipse":"Ellipse select","tool.selectPoly":"Polygon select","tool.selectFree":"Free select","tool.selectWand":"Magic wand","opt.tolerance":"Tolerance","sel.all":"Select all","sel.deselect":"Deselect","sel.invert":"Invert","sel.cropToSel":"Crop to selection","sel.delete":"Delete","tool.zoomIn":"Zoom in","tool.zoomOut":"Zoom out","tool.zoomFit":"Fit to window","opt.fontWeight":"Weight","opt.fontStyle":"Style","opt.letterSpacing":"Spacing","opt.lineHeight":"Line height","opt.textDecoration":"Decoration","opt.align":"Align","layer.resize":"Resize Layer","btn.import":"Import","btn.export":"Export","export.title":"Export Image","export.format":"Format","export.quality":"Quality","export.dimensions":"Dimensions","export.fileSize":"Estimated Size","export.download":"Download","layer.styles":"Layer Styles","effect.dropShadow":"Drop Shadow","effect.innerShadow":"Inner Shadow","effect.outerGlow":"Outer Glow","effect.stroke":"Stroke","effect.colorOverlay":"Color Overlay","effect.border":"Border","effect.gradientOverlay":"Gradient Overlay","effect.borderStyle":"Style","effect.borderRadius":"Radius","effect.gradientType":"Type","effect.gradientAngle":"Angle","effect.color1":"Color 1","effect.color2":"Color 2","effect.linear":"Linear","effect.radial":"Radial","effect.solid":"Solid","effect.dashed":"Dashed","effect.dotted":"Dotted","effect.color":"Color","effect.opacity":"Opacity","effect.blur":"Blur","effect.offsetX":"Offset X","effect.offsetY":"Offset Y","effect.size":"Size","effect.position":"Position","effect.blendMode":"Blend Mode","fonts.title":"Google Fonts","fonts.search":"Search fonts…","fonts.custom":"Custom font name","fonts.load":"Load","fonts.loading":"Loading…","fonts.loaded":"Loaded fonts","fonts.popular":"Popular fonts","menu.file":"File","menu.edit":"Edit","menu.image":"Image","menu.layer":"Layer","menu.select":"Select","menu.view":"View","menu.help":"Help","menu.about":"About Shou Editor","menu.shortcuts":"Keyboard Shortcuts","menu.newLayer":"New Layer","menu.deleteLayer":"Delete Layer","menu.duplicateLayer":"Duplicate Layer","menu.newGroup":"New Group","menu.layerStyles":"Layer Styles","menu.resizeLayer":"Resize Layer","menu.transform":"Transform","menu.filters":"Filters","menu.panels":"Panels","menu.showLayers":"Layers Panel","menu.showFilters":"Filters Panel","menu.showStatusBar":"Status Bar","menu.cut":"Cut","menu.copy":"Copy","menu.paste":"Paste","menu.delete":"Delete","menu.saveProject":"Save Project","menu.openProject":"Open Project"},es:{"tool.undo":"Deshacer","tool.redo":"Rehacer","tool.crop":"Recortar","tool.resize":"Redimensionar","tool.rotateLeft":"Rotar izquierda","tool.rotateRight":"Rotar derecha","tool.flipH":"Voltear horizontal","tool.flipV":"Voltear vertical","tool.pencil":"Lápiz","tool.rect":"Rectángulo","tool.circle":"Círculo","tool.line":"Línea","tool.arrow":"Flecha","tool.text":"Texto","tool.eraser":"Borrador","btn.save":"Guardar","btn.cancel":"Cancelar","btn.reset":"Restablecer","btn.apply":"Aplicar","filter.brightness":"Brillo","filter.contrast":"Contraste","filter.saturation":"Saturación","filter.blur":"Desenfoque","filter.grayscale":"Escala de grises","filter.sepia":"Sepia","filter.hue":"Tono","opt.color":"Color","opt.fill":"Relleno","opt.size":"Tamaño","opt.font":"Fuente","opt.fontSize":"Tamaño fuente","opt.width":"Ancho","opt.height":"Alto","opt.lockRatio":"Mantener proporción","opt.opacity":"Opacidad","empty.loadImage":"Arrastra una imagen aquí o haz clic para cargar","confirm.reset":"¿Restablecer imagen original?","panel.layers":"Capas","panel.image":"Imagen","layer.add":"Nueva capa","layer.delete":"Eliminar capa","layer.duplicate":"Duplicar capa","layer.background":"Fondo","layer.group":"Nuevo grupo","opt.blendMode":"Mezcla","tool.move":"Mover","tool.pan":"Desplazar","tool.eyedropper":"Cuentagotas","tool.fill":"Relleno","tool.gradient":"Degradado","opt.tolerance":"Tolerancia","opt.color1":"Color 1","opt.color2":"Color 2","opt.align":"Alinear","tool.selectRect":"Selección rectangular","tool.selectEllipse":"Selección elíptica","tool.selectPoly":"Selección poligonal","tool.selectFree":"Selección libre","tool.selectWand":"Varita mágica","opt.tolerance":"Tolerancia","sel.all":"Seleccionar todo","sel.deselect":"Deseleccionar","sel.invert":"Invertir","sel.cropToSel":"Recortar a selección","sel.delete":"Eliminar","tool.zoomIn":"Ampliar","tool.zoomOut":"Reducir","tool.zoomFit":"Ajustar a ventana","opt.fontWeight":"Grosor","opt.fontStyle":"Estilo","opt.letterSpacing":"Espaciado","opt.lineHeight":"Interlineado","opt.textDecoration":"Decoración","opt.align":"Alinear","layer.resize":"Redimensionar capa","btn.import":"Importar","btn.export":"Exportar","export.title":"Exportar Imagen","export.format":"Formato","export.quality":"Calidad","export.dimensions":"Dimensiones","export.fileSize":"Tamaño estimado","export.download":"Descargar","layer.styles":"Estilos de Capa","effect.dropShadow":"Sombra Paralela","effect.innerShadow":"Sombra Interior","effect.outerGlow":"Resplandor Exterior","effect.stroke":"Trazo","effect.colorOverlay":"Superposición de Color","effect.border":"Borde","effect.gradientOverlay":"Degradado","effect.borderStyle":"Estilo","effect.borderRadius":"Radio","effect.gradientType":"Tipo","effect.gradientAngle":"Ángulo","effect.color1":"Color 1","effect.color2":"Color 2","effect.linear":"Lineal","effect.radial":"Radial","effect.solid":"Sólido","effect.dashed":"Discontinuo","effect.dotted":"Punteado","effect.color":"Color","effect.opacity":"Opacidad","effect.blur":"Desenfoque","effect.offsetX":"Desplazamiento X","effect.offsetY":"Desplazamiento Y","effect.size":"Tamaño","effect.position":"Posición","effect.blendMode":"Modo de Fusión","fonts.title":"Google Fonts","fonts.search":"Buscar fuentes…","fonts.custom":"Nombre de fuente personalizado","fonts.load":"Cargar","fonts.loading":"Cargando…","fonts.loaded":"Fuentes cargadas","fonts.popular":"Fuentes populares","menu.file":"Archivo","menu.edit":"Editar","menu.image":"Imagen","menu.layer":"Capa","menu.select":"Selección","menu.view":"Vista","menu.help":"Ayuda","menu.about":"Acerca de Shou Editor","menu.shortcuts":"Atajos de teclado","menu.newLayer":"Nueva capa","menu.deleteLayer":"Eliminar capa","menu.duplicateLayer":"Duplicar capa","menu.newGroup":"Nuevo grupo","menu.layerStyles":"Estilos de capa","menu.resizeLayer":"Redimensionar capa","menu.transform":"Transformar","menu.filters":"Filtros","menu.panels":"Paneles","menu.showLayers":"Panel de capas","menu.showFilters":"Panel de filtros","menu.showStatusBar":"Barra de estado","menu.cut":"Cortar","menu.copy":"Copiar","menu.paste":"Pegar","menu.delete":"Eliminar","menu.saveProject":"Guardar proyecto","menu.openProject":"Abrir proyecto"}};let a="en";function r(e){return o[a]&&o[a][e]||o.en[e]||e}const n={undo:'<svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05 1-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>',redo:'<svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.97 7.22L3.9 16c1.05-3.19 4.06-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>',crop:'<svg viewBox="0 0 24 24"><path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/></svg>',resize:'<svg viewBox="0 0 24 24"><path d="M21 11V3h-8l3.29 3.29-10 10L3 13v8h8l-3.29-3.29 10-10z"/></svg>',rotateLeft:'<svg viewBox="0 0 24 24"><path d="M7.11 8.53L5.7 7.11C4.8 8.27 4.24 9.61 4.07 11h2.02c.14-.87.49-1.72 1.02-2.47zM6.09 13H4.07c.17 1.39.72 2.73 1.62 3.89l1.41-1.42c-.52-.75-.87-1.59-1.01-2.47zM7.1 18.32c1.16.9 2.51 1.44 3.9 1.61V17.9c-.87-.15-1.71-.49-2.46-1.03L7.1 18.32zM13 4.07V1L8.45 5.55 13 10V6.09c2.84.48 5 2.94 5 5.91s-2.16 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93s-3.05-7.44-7-7.93z"/></svg>',rotateRight:'<svg viewBox="0 0 24 24"><path d="M15.55 5.55L11 1v3.07C7.06 4.56 4 7.92 4 12s3.05 7.44 7 7.93v-2.02c-2.84-.48-5-2.94-5-5.91s2.16-5.43 5-5.91V10l4.55-4.45zM19.93 11c-.17-1.39-.72-2.73-1.62-3.89l-1.42 1.42c.54.75.88 1.6 1.02 2.47h2.02zM13 17.9v2.02c1.39-.17 2.74-.71 3.9-1.61l-1.44-1.44c-.75.54-1.59.89-2.46 1.03zm3.89-2.42l1.42 1.41c.9-1.16 1.45-2.5 1.62-3.89h-2.02c-.14.87-.48 1.72-1.02 2.48z"/></svg>',flipH:'<svg viewBox="0 0 24 24"><path d="M15 21h2v-2h-2v2zm4-12h2V7h-2v2zM3 5v14c0 1.1.9 2 2 2h4v-2H5V5h4V3H5c-1.1 0-2 .9-2 2zm16-2v2h2c0-1.1-.9-2-2-2zm-8-2h2v22h-2V1zm8 10h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-4h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2z"/></svg>',flipV:'<svg viewBox="0 0 24 24"><path d="M21 15v2h-2v-2h2zm-12 4v2H7v-2h2zM5 3c-1.1 0-2 .9-2 2h2V3zm14 0v2h2c0-1.1-.9-2-2-2zM1 11v2h22v-2H1zm10-8v2h-2V3h2zm0 18h-2v2h2v-2zM3 19c0 1.1.9 2 2 2v-2H3zm0-4h2v-2H3v2zm0-8h2V5H3v2zm16 4h2v-2h-2v2zm0 8v-2h2c0 1.1-.9 2-2 2zm0-4h2v-2h-2v2z"/></svg>',pencil:'<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 000-1.42l-2.34-2.34a1.003 1.003 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>',rect:'<svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm2 2v14h14V5H5z"/></svg>',circle:'<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>',line:'<svg viewBox="0 0 24 24"><path d="M4.22 19.78a.75.75 0 010-1.06L18.72 4.22a.75.75 0 011.06 1.06L5.28 19.78a.75.75 0 01-1.06 0z"/></svg>',arrow:'<svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>',text:'<svg viewBox="0 0 24 24"><path d="M5 4v3h5.5v12h3V7H19V4z"/></svg>',eraser:'<svg viewBox="0 0 24 24"><path d="M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.78.77-.78 2.04 0 2.83l3.85 3.85h7.49l8.48-8.48c.78-.78.78-2.05 0-2.83l-5.86-5.86A2.006 2.006 0 0015.14 3zM5.04 18.96l-1.42-1.42 5.14-5.14 1.41 1.41-5.13 5.15z"/></svg>',save:'<svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>',cancel:'<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',reset:'<svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>',upload:'<svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>',eye:'<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>',eyeOff:'<svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 001 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>',layerAdd:'<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>',layerDelete:'<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',layerDup:'<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>',move:'<svg viewBox="0 0 24 24"><path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"/></svg>',pan:'<svg viewBox="0 0 24 24"><path d="M18 24h-6.55c-1.08 0-2.14-.45-2.89-1.23l-5.5-6.04.84-.72c.5-.43 1.21-.51 1.77-.22L9 17.89V3.5a1.5 1.5 0 013 0v5h.5a1.5 1.5 0 013 0V9a1.5 1.5 0 013 0v1.5a1.5 1.5 0 013 0V19c0 2.76-2.24 5-5 5zM5.96 17.27l4.09 4.49c.43.47 1.03.74 1.65.74H18c1.65 0 3-1.35 3-3v-7.5a.5.5 0 00-1 0V14h-1v-3.5a.5.5 0 00-1 0V14h-1v-4a.5.5 0 00-1 0v4h-1V3.5a.5.5 0 00-1 0v10.26l-4.42-2.45c-.18-.1-.4-.08-.56.05l-.23.19 4.17 5.45H11V17l-5.04-2.73V17.27z"/></svg>',eyedropper:'<svg viewBox="0 0 24 24"><path d="M20.71 5.63l-2.34-2.34a1 1 0 00-1.41 0l-3.12 3.12-1.42-1.42-1.41 1.42 1.41 1.41L3.71 16.53c-.2.19-.31.45-.31.72V21h3.75c.27 0 .52-.11.71-.29l8.72-8.72 1.41 1.41 1.42-1.41-1.42-1.42 3.12-3.12a1 1 0 000-1.42zM6.92 19H5v-1.92l8.06-8.06 1.92 1.92L6.92 19z"/></svg>',fill:'<svg viewBox="0 0 24 24"><path d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15a1.49 1.49 0 000 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.12zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z"/></svg>',gradient:'<svg viewBox="0 0 24 24"><path d="M11 9h2v2h-2V9zm-2 2h2v2H9v-2zm4 0h2v2h-2v-2zm2-2h2v2h-2V9zM7 9h2v2H7V9zm12-6H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 18H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm2-7h-2v2h2v2h-2v-2h-2v2h-2v-2h-2v2H9v-2H7v2H5v-2h2v-2H5V5h14v6z"/></svg>',folder:'<svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>',folderOpen:'<svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>',chevronRight:'<svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>',chevronDown:'<svg viewBox="0 0 24 24"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/></svg>',selectRect:'<svg viewBox="0 0 24 24"><path d="M3 3h4v2H5v2H3V3zm8 0h2v2h-2V3zm6 0h4v4h-2V5h-2V3zM3 11h2v2H3v-2zm16 0h2v2h-2v-2zM3 17h2v2h2v2H3v-4zm8 2h2v2h-2v-2zm6 0h2v2h2v-2h-2zm2-2h2v-2h-2v2z"/></svg>',selectEllipse:'<svg viewBox="0 0 24 24"><path d="M12 4c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8zm0 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/><path d="M12 2c-.6 0-1.19.05-1.76.16l.35 1.97A8.1 8.1 0 0112 4c.47 0 .94.04 1.39.13l.37-1.97C13.19 2.05 12.6 2 12 2z" opacity=".5"/></svg>',selectPoly:'<svg viewBox="0 0 24 24"><path d="M2 4l5 16h10l5-12-8-7L2 4zm3.09 1.63L12 3.2l6.18 5.41L14.27 18H7.73L3.09 5.63z"/></svg>',selectFree:'<svg viewBox="0 0 24 24"><path d="M15.5 2C13 2 10.7 3.2 9.3 5.1c-.8-.1-1.5-.1-2.3-.1C3.6 5 1 7.6 1 11c0 2.9 2 5.4 4.8 5.9l.4-2C4.3 14.5 3 13 3 11c0-2.2 1.8-4 4-4 .3 0 .5 0 .8.1C8.6 9.4 10.8 11 13.5 11c.5 0 1-.1 1.5-.2l-.5-2c-.3.1-.7.2-1 .2-1.9 0-3.5-1.1-4.2-2.7C10.4 4.3 12.7 3 15.5 3 18.5 3 21 5.5 21 8.5S18.5 14 15.5 14v2c3.6 0 6.5-2.9 6.5-6.5S19.1 2 15.5 2z"/></svg>',selectWand:'<svg viewBox="0 0 24 24"><path d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7l2.5-1.4zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14l-2.5 1.4zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5L22 2zM14.37 7.29L12.4 9.27l2.34 2.34 1.98-1.98c.39-.39.39-1.02 0-1.41l-.93-.93c-.39-.39-1.03-.39-1.42 0zM11.34 10.34l-7.26 7.26c-.39.39-.39 1.02 0 1.41l.93.93c.39.39 1.02.39 1.41 0l7.26-7.26-2.34-2.34z"/></svg>',zoomIn:'<svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm.5-7H9v2H7v1h2v2h1v-2h2V9h-2z"/></svg>',zoomOut:'<svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z"/></svg>',zoomFit:'<svg viewBox="0 0 24 24"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></svg>',download:'<svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>',importImg:'<svg viewBox="0 0 24 24"><path d="M21 15v4c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2v-4h2v4h14v-4h2zM7 10l1.41 1.41L11 8.83V16h2V8.83l2.59 2.58L17 10l-5-5-5 5z"/></svg>',layerStyles:'<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>'};let l=1;class c{constructor(e={}){this.id=l++,this.name=e.name||`Layer ${this.id}`,this.visible=void 0===e.visible||e.visible,this.opacity=void 0!==e.opacity?e.opacity:1,this.locked=!1,this.blendMode=e.blendMode||"normal",this.effects=e.effects?JSON.parse(JSON.stringify(e.effects)):{dropShadow:{enabled:!1,offsetX:5,offsetY:5,blur:10,color:"#000000",opacity:.75},innerShadow:{enabled:!1,offsetX:5,offsetY:5,blur:10,color:"#000000",opacity:.75},outerGlow:{enabled:!1,blur:10,color:"#ffffff",opacity:.75},stroke:{enabled:!1,size:3,color:"#000000",position:"outside"},colorOverlay:{enabled:!1,color:"#ff0000",opacity:.5,blendMode:"normal"},border:{enabled:!1,size:2,color:"#000000",style:"solid",radius:0,opacity:1},gradientOverlay:{enabled:!1,color1:"#000000",color2:"#ffffff",type:"linear",angle:0,opacity:.75}},this.width=e.width||0,this.height=e.height||0,this.type=e.type||"raster",this.textData=e.textData||null,this.children=[],this.collapsed=!1,this.parentId=e.parentId||null,this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.ctx=this.canvas.getContext("2d"),e.fill&&(this.ctx.fillStyle=e.fill,this.ctx.fillRect(0,0,this.width,this.height)),"text"===this.type&&this.textData&&this._renderText()}_renderText(){if(!this.textData)return;const e=this.textData,t=this.ctx;t.clearRect(0,0,this.width,this.height),t.fillStyle=e.color||"#000000";const i=e.fontStyle||"normal",s=e.fontWeight||"normal",o=e.fontSize||24,a=e.fontFamily||"Arial";t.font=`${i} ${s} ${o}px ${a}`,t.textBaseline="top",t.textAlign=e.align||"left";const r=e.letterSpacing||0;void 0!==t.letterSpacing&&(t.letterSpacing=r+"px");const n=o*(e.lineHeight||1.2),l=(e.text||"").split("\n");let c=e.x||0;"center"===e.align?c=this.width/2:"right"===e.align&&(c=this.width);const h=e.textDecoration||"none";l.forEach((i,s)=>{const a=(e.y||0)+s*n;if(0!==r&&void 0===t.letterSpacing){let s=c;const o=e.align||"left";if("center"===o||"right"===o){let e=0;for(let s=0;s<i.length;s++)e+=t.measureText(i[s]).width+(s<i.length-1?r:0);s-="center"===o?e/2:e}const n=t.textAlign;t.textAlign="left";for(let e=0;e<i.length;e++)t.fillText(i[e],s,a),s+=t.measureText(i[e]).width+r;t.textAlign=n}else t.fillText(i,c,a);if("none"!==h&&i.length>0){const s=t.measureText(i);let r=c;const n=s.width,l=e.align||"left";"center"===l?r-=n/2:"right"===l&&(r-=n);let d=0;"underline"===h?d=a+.95*o:"line-through"===h&&(d=a+.55*o),t.fillRect(r,d,n,Math.max(1,o/16))}}),void 0!==t.letterSpacing&&(t.letterSpacing="0px")}resize(e,t){const i=document.createElement("canvas");i.width=e,i.height=t;i.getContext("2d").drawImage(this.canvas,0,0,e,t),this.canvas.width=e,this.canvas.height=t,this.width=e,this.height=t,this.ctx.drawImage(i,0,0)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}getThumbnail(e=40,t=30){const i=document.createElement("canvas");i.width=e,i.height=t;const s=i.getContext("2d");s.fillStyle="#ccc",s.fillRect(0,0,e,t);for(let i=0;i<t;i+=4)for(let t=0;t<e;t+=4)(Math.floor(t/4)+Math.floor(i/4))%2==0&&(s.fillStyle="#fff",s.fillRect(t,i,4,4));const o=Math.min(e/this.width,t/this.height),a=this.width*o,r=this.height*o,n=(e-a)/2,l=(t-r)/2;return s.drawImage(this.canvas,n,l,a,r),i.toDataURL()}serialize(){const e={id:this.id,name:this.name,visible:this.visible,opacity:this.opacity,locked:this.locked,blendMode:this.blendMode,width:this.width,height:this.height,type:this.type,textData:this.textData?{...this.textData}:null,parentId:this.parentId,collapsed:this.collapsed};return"group"===this.type?e.children=this.children.map(e=>e.serialize()):e.imageData=this.ctx.getImageData(0,0,this.width,this.height),e}serializeForProject(){const e={id:this.id,name:this.name,visible:this.visible,opacity:this.opacity,locked:this.locked,blendMode:this.blendMode,width:this.width,height:this.height,type:this.type,textData:this.textData?{...this.textData}:null,parentId:this.parentId,collapsed:this.collapsed,effects:JSON.parse(JSON.stringify(this.effects))};return"group"===this.type?e.children=this.children.map(e=>e.serializeForProject()):e.imageDataURL=this.canvas.toDataURL("image/png"),e}static deserializeFromProject(e){return new Promise(t=>{const i=new c({name:e.name,width:e.width,height:e.height,visible:e.visible,opacity:e.opacity,blendMode:e.blendMode,type:e.type||"raster",textData:e.textData?{...e.textData}:null,parentId:e.parentId||null,effects:e.effects||void 0});if(i.id=e.id,i.locked=e.locked,i.collapsed=!!e.collapsed,"group"===e.type&&e.children)Promise.all(e.children.map(e=>c.deserializeFromProject(e))).then(e=>{i.children=e,t(i)});else if(e.imageDataURL){const s=new Image;s.onload=()=>{i.ctx.drawImage(s,0,0),"text"===i.type&&i.textData&&i._renderText(),t(i)},s.onerror=()=>t(i),s.src=e.imageDataURL}else"text"===i.type&&i.textData&&i._renderText(),t(i)})}static deserialize(e){const t=new c({name:e.name,width:e.width,height:e.height,visible:e.visible,opacity:e.opacity,blendMode:e.blendMode,type:e.type||"raster",textData:e.textData?{...e.textData}:null,parentId:e.parentId||null});return t.id=e.id,t.locked=e.locked,t.collapsed=!!e.collapsed,"group"===e.type&&e.children?t.children=e.children.map(e=>c.deserialize(e)):e.imageData&&t.ctx.putImageData(e.imageData,0,0),"text"===t.type&&t.textData&&t._renderText(),t}}class h{constructor(){this.layers=[],this.activeLayerId=null,this.docWidth=0,this.docHeight=0}get activeLayer(){return this.layers.find(e=>e.id===this.activeLayerId)||null}get activeIndex(){return this.layers.findIndex(e=>e.id===this.activeLayerId)}initFromImage(e){this.docWidth=e.width,this.docHeight=e.height,this.layers=[];const t=new c({name:r("layer.background"),width:e.width,height:e.height});t.ctx.drawImage(e,0,0),this.layers.push(t),this.activeLayerId=t.id}initFromPreset(e){if(this.docWidth=e.width||800,this.docHeight=e.height||600,this.layers=[],e.layers&&e.layers.length>0)for(const t of e.layers){const e=new c({name:t.name||`Layer ${l}`,width:this.docWidth,height:this.docHeight,opacity:void 0!==t.opacity?t.opacity:1,fill:t.fill||null});this.layers.push(e)}else{const t=new c({name:r("layer.background"),width:this.docWidth,height:this.docHeight,fill:e.background||"#ffffff"});this.layers.push(t)}this.activeLayerId=this.layers[this.layers.length-1].id}addLayer(e){const t=new c({name:e||`Layer ${l}`,width:this.docWidth,height:this.docHeight}),i=this.activeIndex;return this.layers.splice(i+1,0,t),this.activeLayerId=t.id,t}deleteLayer(e){if(this.layers.length<=1)return!1;const t=this.layers.findIndex(t=>t.id===e);if(-1===t)return!1;if(this.layers.splice(t,1),this.activeLayerId===e){const e=Math.min(t,this.layers.length-1);this.activeLayerId=this.layers[e].id}return!0}duplicateLayer(e){const t=this.layers.find(t=>t.id===e);if(!t)return null;const i=new c({name:t.name+" copy",width:t.width,height:t.height,opacity:t.opacity,visible:t.visible});i.ctx.drawImage(t.canvas,0,0);const s=this.layers.indexOf(t);return this.layers.splice(s+1,0,i),this.activeLayerId=i.id,i}moveLayer(e,t){if(e===t)return;const[i]=this.layers.splice(e,1);this.layers.splice(t,0,i)}setActive(e){this.activeLayerId=e}toggleVisibility(e){const t=this.layers.find(t=>t.id===e);t&&(t.visible=!t.visible)}setOpacity(e,t){const i=this.layers.find(t=>t.id===e);i&&(i.opacity=Math.max(0,Math.min(1,t)))}addGroup(e){const t=new c({name:e||r("layer.group"),width:this.docWidth,height:this.docHeight,type:"group"}),i=this.activeIndex;return this.layers.splice(i+1,0,t),this.activeLayerId=t.id,t}moveToGroup(e,t){if(e===t)return!1;const i=this.layers.find(t=>t.id===e),s=this.layers.find(e=>e.id===t&&"group"===e.type);if(!i||!s)return!1;const o=this.layers.indexOf(i);-1!==o&&this.layers.splice(o,1);for(const e of this.layers)if("group"===e.type){const t=e.children.indexOf(i);-1!==t&&e.children.splice(t,1)}return i.parentId=t,s.children.push(i),!0}removeFromGroup(e){for(const t of this.layers)if("group"===t.type){const i=t.children.findIndex(t=>t.id===e);if(-1!==i){const e=t.children.splice(i,1)[0];e.parentId=null;const s=this.layers.indexOf(t);return this.layers.splice(s+1,0,e),!0}}return!1}_getBlendOp(e){return"normal"===e?"source-over":e}_hexToRgba(e,t){return`rgba(${parseInt(e.substr(1,2),16)},${parseInt(e.substr(3,2),16)},${parseInt(e.substr(5,2),16)},${t})`}_applyLayerEffects(e){const t=e.effects,i=e.canvas,s=i.width,o=i.height,a=document.createElement("canvas");a.width=s,a.height=o;const r=a.getContext("2d");if(t.dropShadow&&t.dropShadow.enabled){const e=t.dropShadow;r.save(),r.shadowOffsetX=e.offsetX,r.shadowOffsetY=e.offsetY,r.shadowBlur=e.blur,r.shadowColor=this._hexToRgba(e.color,e.opacity),r.drawImage(i,0,0),r.restore(),r.save(),r.globalCompositeOperation="destination-out",r.drawImage(i,0,0),r.restore()}if(t.outerGlow&&t.outerGlow.enabled){const e=t.outerGlow;r.save(),r.shadowOffsetX=0,r.shadowOffsetY=0,r.shadowBlur=e.blur,r.shadowColor=this._hexToRgba(e.color,e.opacity),r.drawImage(i,0,0),r.restore(),r.save(),r.globalCompositeOperation="destination-out",r.drawImage(i,0,0),r.restore()}if(r.drawImage(i,0,0),t.stroke&&t.stroke.enabled){const n=t.stroke,l=document.createElement("canvas");l.width=s,l.height=o;const c=l.getContext("2d"),h=e.ctx.getImageData(0,0,s,o).data,d=new ImageData(s,o),p=d.data,u=n.size;for(let e=0;e<o;e++)for(let t=0;t<s;t++){let i=0;for(let a=-u;a<=u;a++)for(let r=-u;r<=u;r++)if(r*r+a*a<=u*u){const n=t+r,l=e+a;n>=0&&n<s&&l>=0&&l<o&&(i=Math.max(i,h[4*(l*s+n)+3]))}const a=4*(e*s+t);p[a]=p[a+1]=p[a+2]=255,p[a+3]=i}if(c.putImageData(d,0,0),c.globalCompositeOperation="source-in",c.fillStyle=n.color,c.fillRect(0,0,s,o),"outside"===n.position){c.globalCompositeOperation="destination-out",c.drawImage(i,0,0),c.globalCompositeOperation="source-over";const e=document.createElement("canvas");e.width=s,e.height=o;const t=e.getContext("2d");t.drawImage(l,0,0),t.drawImage(a,0,0),r.clearRect(0,0,s,o),r.drawImage(e,0,0)}else if("inside"===n.position){c.globalCompositeOperation="destination-in",c.drawImage(i,0,0);const e=document.createElement("canvas");e.width=s,e.height=o;const t=e.getContext("2d");t.drawImage(l,0,0),t.globalCompositeOperation="destination-out";const a=document.createElement("canvas");a.width=s,a.height=o;a.getContext("2d");r.drawImage(l,0,0)}else r.drawImage(l,0,0),r.drawImage(i,0,0)}if(t.innerShadow&&t.innerShadow.enabled){const e=t.innerShadow,a=document.createElement("canvas");a.width=s,a.height=o;const n=a.getContext("2d");n.fillStyle=this._hexToRgba(e.color,e.opacity),n.fillRect(0,0,s,o),n.globalCompositeOperation="destination-out",n.shadowOffsetX=-e.offsetX,n.shadowOffsetY=-e.offsetY,n.shadowBlur=e.blur,n.shadowColor="rgba(0,0,0,1)",n.drawImage(i,0,0),n.globalCompositeOperation="destination-in",n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.drawImage(i,0,0),r.drawImage(a,0,0)}if(t.colorOverlay&&t.colorOverlay.enabled){const e=t.colorOverlay,a=document.createElement("canvas");a.width=s,a.height=o;const n=a.getContext("2d");n.drawImage(i,0,0),n.globalCompositeOperation="source-in",n.fillStyle=e.color,n.fillRect(0,0,s,o),r.globalAlpha=e.opacity,r.globalCompositeOperation="normal"===e.blendMode?"source-over":e.blendMode,r.drawImage(a,0,0),r.globalAlpha=1,r.globalCompositeOperation="source-over"}if(t.gradientOverlay&&t.gradientOverlay.enabled){const e=t.gradientOverlay,a=document.createElement("canvas");a.width=s,a.height=o;const n=a.getContext("2d");let l;if("radial"===e.type){const e=s/2,t=o/2,i=Math.max(s,o)/2;l=n.createRadialGradient(e,t,0,e,t,i)}else{const t=(e.angle||0)*Math.PI/180,i=s/2,a=o/2,r=Math.max(s,o)/2,c=i-Math.cos(t)*r,h=a-Math.sin(t)*r,d=i+Math.cos(t)*r,p=a+Math.sin(t)*r;l=n.createLinearGradient(c,h,d,p)}l.addColorStop(0,e.color1),l.addColorStop(1,e.color2),n.fillStyle=l,n.fillRect(0,0,s,o),n.globalCompositeOperation="destination-in",n.drawImage(i,0,0),r.globalAlpha=e.opacity,r.drawImage(a,0,0),r.globalAlpha=1}if(t.border&&t.border.enabled){const e=t.border;r.save(),r.globalAlpha=e.opacity;const a=i.getContext("2d").getImageData(0,0,s,o).data;let n=s,l=o,c=0,h=0;for(let e=0;e<o;e++)for(let t=0;t<s;t++)a[4*(e*s+t)+3]>0&&(t<n&&(n=t),t>c&&(c=t),e<l&&(l=e),e>h&&(h=e));if(c>=n&&h>=l){const t=c-n+1,i=h-l+1;r.strokeStyle=e.color,r.lineWidth=e.size,"dashed"===e.style?r.setLineDash([3*e.size,2*e.size]):"dotted"===e.style?r.setLineDash([e.size,e.size]):r.setLineDash([]);const s=e.size/2;if(e.radius>0){const o=Math.min(e.radius,t/2,i/2),a=n-s,c=l-s,h=t+e.size,d=i+e.size;r.beginPath(),r.moveTo(a+o,c),r.lineTo(a+h-o,c),r.quadraticCurveTo(a+h,c,a+h,c+o),r.lineTo(a+h,c+d-o),r.quadraticCurveTo(a+h,c+d,a+h-o,c+d),r.lineTo(a+o,c+d),r.quadraticCurveTo(a,c+d,a,c+d-o),r.lineTo(a,c+o),r.quadraticCurveTo(a,c,a+o,c),r.closePath(),r.stroke()}else r.strokeRect(n-s,l-s,t+e.size,i+e.size);r.setLineDash([])}r.restore()}return a}_compositeLayer(e,t){if(e.visible&&0!==e.opacity)if("group"===e.type)this._compositeGroup(e,t);else{const i=e.effects&&Object.values(e.effects).some(e=>e.enabled)?this._applyLayerEffects(e):e.canvas;t.globalAlpha=e.opacity,t.globalCompositeOperation=this._getBlendOp(e.blendMode),t.drawImage(i,0,0),t.globalAlpha=1,t.globalCompositeOperation="source-over"}}_compositeGroup(e,t){if(!e.visible||0===e.opacity||0===e.children.length)return;const i=document.createElement("canvas");i.width=this.docWidth,i.height=this.docHeight;const s=i.getContext("2d");for(const t of e.children)this._compositeLayer(t,s);s.globalAlpha=1,s.globalCompositeOperation="source-over",t.globalAlpha=e.opacity,t.globalCompositeOperation=this._getBlendOp(e.blendMode),t.drawImage(i,0,0)}composite(e){const t=this.docWidth,i=this.docHeight;e.clearRect(0,0,t,i);for(const t of this.layers)this._compositeLayer(t,e);e.globalAlpha=1,e.globalCompositeOperation="source-over"}flatten(){const e=document.createElement("canvas");return e.width=this.docWidth,e.height=this.docHeight,this.composite(e.getContext("2d")),e}serialize(){return{docWidth:this.docWidth,docHeight:this.docHeight,activeLayerId:this.activeLayerId,layers:this.layers.map(e=>e.serialize())}}restore(e){this.docWidth=e.docWidth,this.docHeight=e.docHeight,this.activeLayerId=e.activeLayerId,this.layers=e.layers.map(e=>c.deserialize(e))}serializeForProject(){return{docWidth:this.docWidth,docHeight:this.docHeight,activeLayerId:this.activeLayerId,layers:this.layers.map(e=>e.serializeForProject())}}async restoreFromProject(e){this.docWidth=e.docWidth,this.docHeight=e.docHeight,this.activeLayerId=e.activeLayerId,this.layers=await Promise.all(e.layers.map(e=>c.deserializeFromProject(e)))}}class d{constructor(e,i={}){"string"==typeof e||e instanceof Element?(this.container="string"==typeof e?t(e):e,this.config={...this.getDefaultConfig(),...i}):(this.container=document.body,this.config={...this.getDefaultConfig(),...e}),a=this.config.lang||"en",this.layerManager=null,this.currentTool=null,this.drawing=!1,this.filters={brightness:100,contrast:100,saturation:100,blur:0,grayscale:0,sepia:0,hue:0},this.drawColor="#ff0000",this.fillColor="#ff0000",this.fillEnabled=!1,this.strokeSize=3,this.fontSize=24,this.fontFamily="Arial",this.fontWeight="normal",this.fontStyle="normal",this.letterSpacing=0,this.lineHeight=1.2,this.textAlign="left",this.textDecoration="none",this.history=[],this.historyIndex=-1,this.shapeStart=null,this._shapeSnapshot=null,this._thumbTimer=null,this.fillTolerance=30,this.gradientColor1="#ff0000",this.gradientColor2="#0000ff",this._moveSnapshot=null,this._moveStart=null,this.selection=null,this._selectionPath=null,this._selectionPoints=[],this._selectionAnimFrame=null,this._selectionAntsOffset=0,this._selectionStart=null,this._selectionPreview=null,this._clipboard=null,this._toolGroupSelection={},this.wandTolerance=30,this.zoomLevel=1,this._fitScale=1,this._init()}getDefaultConfig(){return{...d._externalConfig||{theme:"dark",width:"100%",height:"100%",maxHistory:20,outputFormat:"png",outputQuality:.92,lang:"en",tools:{drawing:["move","pan",{group:"select",tools:["selectRect","selectEllipse","selectPoly","selectFree","selectWand"]},"pencil","eraser","eyedropper","fill","gradient",{group:"shapes",tools:["rect","circle","line","arrow"]},"text"],transform:["crop","resize",{group:"orient",tools:["rotateLeft","rotateRight","flipH","flipV"]}]},panels:{layers:!0,filters:!0,statusBar:!0},filters:["brightness","contrast","saturation","blur","grayscale","sepia","hue"],preset:null},onSave:null,onCancel:null}}static async loadConfig(e){try{const t=await fetch(e);t.ok&&(d._externalConfig=await t.json())}catch(t){console.warn("JSImageEditor: Could not load config from",e,"- using defaults")}}_init(){this.injectCSS(),this.render(),this.cacheElements(),this.bindEvents(),this.config.preset&&this._initFromPreset(this.config.preset)}injectCSS(){if(!t("#jsie-styles")){const e=document.createElement("style");e.id="jsie-styles",e.textContent='\n/* Base */\n.jsie-editor{display:flex;flex-direction:column;width:100%;height:100%;font-family:-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif;font-size:13px;overflow:hidden;user-select:none;background:var(--jsie-bg);color:var(--jsie-text)}\n\n/* Theme vars */\n.jsie-editor.theme-dark{--jsie-bg:#1e1e1e;--jsie-bg2:#252526;--jsie-bg3:#2d2d2d;--jsie-text:#d4d4d4;--jsie-text2:#858585;--jsie-border:#3c3c3c;--jsie-accent:#007acc;--jsie-hover:#2a2d2e;--jsie-btn:#3c3c3c;--jsie-btn-hover:#4c4c4c;--jsie-input-bg:#3c3c3c;--jsie-slider-track:#555;--jsie-slider-thumb:#007acc;--jsie-layer-active:#094771}\n.jsie-editor.theme-light{--jsie-bg:#ffffff;--jsie-bg2:#f3f3f3;--jsie-bg3:#e8e8e8;--jsie-text:#1e1e1e;--jsie-text2:#666;--jsie-border:#e0e0e0;--jsie-accent:#007acc;--jsie-hover:#e8e8e8;--jsie-btn:#e0e0e0;--jsie-btn-hover:#d0d0d0;--jsie-input-bg:#fff;--jsie-slider-track:#ccc;--jsie-slider-thumb:#007acc;--jsie-layer-active:#c8e1ff}\n\n/* Menu bar */\n.jsie-menubar{display:flex;align-items:center;padding:0 4px;background:var(--jsie-bg2);border-bottom:1px solid var(--jsie-border);height:26px;gap:0;position:relative;z-index:10004;flex-shrink:0}\n.jsie-menu-item{padding:3px 10px;cursor:pointer;font-size:12px;color:var(--jsie-text);border-radius:3px;white-space:nowrap;user-select:none;position:relative}\n.jsie-menu-item:hover{background:var(--jsie-hover)}\n.jsie-menu-item.open{background:var(--jsie-accent);color:#fff}\n.jsie-menu-dropdown{position:absolute;top:100%;left:0;min-width:220px;background:var(--jsie-bg2);border:1px solid var(--jsie-border);border-radius:4px;box-shadow:0 6px 20px rgba(0,0,0,.35);z-index:10005;padding:4px 0;margin-top:1px}\n.jsie-menu-entry{display:flex;align-items:center;padding:5px 12px 5px 10px;cursor:pointer;font-size:12px;color:var(--jsie-text);gap:8px;white-space:nowrap;position:relative}\n.jsie-menu-entry:hover{background:var(--jsie-hover)}\n.jsie-menu-entry.disabled{opacity:.4;pointer-events:none}\n.jsie-menu-entry svg{width:16px;height:16px;fill:currentColor;flex-shrink:0}\n.jsie-menu-entry-icon{width:16px;height:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0}\n.jsie-menu-entry-label{flex:1}\n.jsie-menu-shortcut{margin-left:auto;font-size:11px;color:var(--jsie-text2);padding-left:20px}\n.jsie-menu-separator{height:1px;background:var(--jsie-border);margin:4px 8px}\n.jsie-menu-sub-arrow{margin-left:auto;font-size:10px;color:var(--jsie-text2)}\n.jsie-menu-has-sub{position:relative}\n.jsie-menu-submenu{position:absolute;left:100%;top:-4px;min-width:180px;background:var(--jsie-bg2);border:1px solid var(--jsie-border);border-radius:4px;box-shadow:0 6px 20px rgba(0,0,0,.35);z-index:10006;padding:4px 0}\n.jsie-menu-check{width:16px;text-align:center;font-size:12px;flex-shrink:0}\n\n/* Options bar (top) */\n.jsie-options-bar{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;background:var(--jsie-bg2);border-bottom:1px solid var(--jsie-border);min-height:38px;gap:4px}\n.jsie-options-left,.jsie-options-right{display:flex;align-items:center;gap:4px}\n.jsie-options-left .jsie-sep{width:1px;height:24px;background:var(--jsie-border);margin:0 4px}\n.jsie-tool-options{display:flex;align-items:center;gap:8px;font-size:12px}\n.jsie-tool-options label{color:var(--jsie-text2);font-size:11px;white-space:nowrap}\n.jsie-tool-options input[type="color"]{width:28px;height:24px;border:1px solid var(--jsie-border);border-radius:3px;padding:1px;cursor:pointer;background:transparent}\n.jsie-tool-options input[type="range"]{width:70px;height:4px;-webkit-appearance:none;appearance:none;background:var(--jsie-slider-track);border-radius:2px;outline:none;cursor:pointer}\n.jsie-tool-options input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--jsie-slider-thumb);cursor:pointer;border:2px solid var(--jsie-bg)}\n.jsie-tool-options input[type="range"]::-moz-range-thumb{width:12px;height:12px;border-radius:50%;background:var(--jsie-slider-thumb);cursor:pointer;border:2px solid var(--jsie-bg)}\n.jsie-tool-options input[type="number"]{width:50px;height:24px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 4px;font-size:11px}\n.jsie-tool-options select{height:24px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 4px;font-size:11px}\n.jsie-tool-options .jsie-opt-check{display:flex;align-items:center;gap:3px}\n.jsie-tool-options .jsie-opt-check input[type="checkbox"]{width:auto;height:auto}\n.jsie-text-opts{display:flex;flex-wrap:wrap;align-items:center;gap:6px 10px}\n.jsie-text-opts label{color:var(--jsie-text2);font-size:10px;white-space:nowrap}\n.jsie-text-opts select{height:22px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 4px;font-size:10px;max-width:120px}\n.jsie-text-opts input[type="color"]{width:24px;height:22px;border:1px solid var(--jsie-border);border-radius:3px;padding:1px;cursor:pointer;background:transparent}\n.jsie-text-opts input[type="number"]{width:46px;height:22px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 4px;font-size:10px}\n.jsie-text-opts .jsie-sep-v{width:1px;height:16px;background:var(--jsie-border);display:inline-block}\n.jsie-text-opts .jsie-align-btn{width:24px;height:22px;border:1px solid var(--jsie-border);background:var(--jsie-input-bg);color:var(--jsie-text);border-radius:3px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;padding:0}\n.jsie-text-opts .jsie-align-btn.active{background:var(--jsie-accent);color:#fff;border-color:var(--jsie-accent)}\n.jsie-text-opts .jsie-align-btn svg{width:14px;height:14px;fill:currentColor}\n.jsie-gf-trigger{width:22px;height:22px;border:1px solid var(--jsie-border);background:var(--jsie-input-bg);color:var(--jsie-accent);border-radius:3px;cursor:pointer;font-weight:700;font-size:11px;display:inline-flex;align-items:center;justify-content:center;padding:0;margin-left:4px;flex-shrink:0}\n.jsie-gf-trigger:hover{background:var(--jsie-accent);color:#fff}\n.jsie-gf-chip{padding:4px 10px;border:1px solid var(--jsie-border);background:var(--jsie-input-bg);color:var(--jsie-text);border-radius:4px;cursor:pointer;font-size:12px;white-space:nowrap;transition:background .15s,border-color .15s}\n.jsie-gf-chip:hover{border-color:var(--jsie-accent);background:rgba(0,120,255,.1)}\n.jsie-gf-chip.loaded{border-color:var(--jsie-accent);color:var(--jsie-accent)}\n.jsie-gf-chip:disabled{opacity:.5;cursor:wait}\n.jsie-color-combo{display:inline-flex;align-items:center;gap:3px}\n.jsie-hex-input{width:62px;height:22px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 4px;font-size:10px;font-family:monospace}\n.jsie-palette-btn{width:22px;height:22px;border:1px solid var(--jsie-border);background:var(--jsie-input-bg);color:var(--jsie-text2);border-radius:3px;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;justify-content:center;padding:0;line-height:1}\n.jsie-palette-btn:hover{border-color:var(--jsie-accent);color:var(--jsie-accent)}\n.jsie-color-palette{position:absolute;z-index:10002;background:var(--jsie-bg);border:1px solid var(--jsie-border);border-radius:6px;padding:8px;display:flex;flex-wrap:wrap;gap:3px;width:214px;box-shadow:0 4px 12px rgba(0,0,0,.3)}\n.jsie-swatch{width:20px;height:20px;border-radius:3px;cursor:pointer;border:1px solid rgba(255,255,255,.1);transition:transform .1s}\n.jsie-swatch:hover{transform:scale(1.3);z-index:1;border-color:var(--jsie-accent)}\n\n/* Buttons */\n.jsie-btn{display:flex;align-items:center;justify-content:center;width:30px;height:30px;border:none;background:transparent;color:var(--jsie-text);border-radius:4px;cursor:pointer;padding:0;transition:background .15s}\n.jsie-btn:hover{background:var(--jsie-hover)}\n.jsie-btn.active{background:var(--jsie-accent);color:#fff}\n.jsie-btn svg{width:18px;height:18px;fill:currentColor}\n.jsie-btn-text{display:flex;align-items:center;gap:4px;height:28px;padding:0 10px;border:none;background:var(--jsie-accent);color:#fff;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;white-space:nowrap}\n.jsie-btn-text:hover{opacity:.9}\n.jsie-btn-text.secondary{background:var(--jsie-btn);color:var(--jsie-text)}\n.jsie-btn-text.secondary:hover{background:var(--jsie-btn-hover)}\n.jsie-btn-text svg{width:14px;height:14px;fill:currentColor}\n\n/* Main body: 3-column layout */\n.jsie-main-body{display:flex;flex:1;overflow:hidden}\n\n/* Left toolbox */\n.jsie-toolbox{width:40px;background:var(--jsie-bg2);border-right:1px solid var(--jsie-border);display:flex;flex-direction:column;align-items:center;padding:4px 0;gap:1px;flex-shrink:0}\n.jsie-tool-btn{width:32px;height:32px;border:none;background:transparent;color:var(--jsie-text);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;transition:background .15s}\n.jsie-tool-btn:hover{background:var(--jsie-hover)}\n.jsie-tool-btn.active{background:var(--jsie-accent);color:#fff}\n.jsie-tool-btn svg{width:18px;height:18px;fill:currentColor}\n.jsie-tool-sep{width:24px;height:1px;background:var(--jsie-border);margin:3px 0}\n.jsie-tool-group{position:relative}\n.jsie-group-arrow{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:pointer;display:flex;align-items:flex-end;justify-content:flex-end;padding:2px}\n.jsie-group-arrow::after{content:\'\';width:0;height:0;border-left:4px solid transparent;border-top:4px solid currentColor}\n.jsie-group-submenu{position:absolute;left:calc(100% + 2px);top:0;background:var(--jsie-bg2);border:1px solid var(--jsie-border);border-radius:4px;padding:4px;display:flex;flex-direction:column;gap:2px;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.3)}\n.jsie-group-submenu .jsie-tool-btn{width:32px;height:32px}\n.jsie-group-submenu .jsie-tool-btn.active{background:var(--jsie-accent);color:#fff}\n\n/* Center canvas */\n.jsie-canvas-area{flex:1;display:flex;overflow:auto;background:var(--jsie-bg3);position:relative}\n.jsie-canvas-wrap{position:relative;display:inline-block;box-shadow:0 2px 12px rgba(0,0,0,0.3);margin:auto;flex-shrink:0;background-color:#fff;background-image:linear-gradient(45deg,#d0d0d0 25%,transparent 25%,transparent 75%,#d0d0d0 75%),linear-gradient(45deg,#d0d0d0 25%,transparent 25%,transparent 75%,#d0d0d0 75%);background-size:16px 16px;background-position:0 0,8px 8px}\n.jsie-canvas-wrap canvas{display:block}\n.jsie-canvas-wrap .jsie-interaction-canvas{position:absolute;top:0;left:0;z-index:5}\n\n/* Right layers panel */\n.jsie-layers-panel{width:220px;background:var(--jsie-bg2);border-left:1px solid var(--jsie-border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}\n.jsie-rpanel-tabs{display:flex;border-bottom:1px solid var(--jsie-border);flex-shrink:0}\n.jsie-rpanel-tab{flex:1;padding:7px 0;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;text-align:center;color:var(--jsie-text2);cursor:pointer;background:none;border:none;border-bottom:2px solid transparent;transition:color .15s,border-color .15s}\n.jsie-rpanel-tab:hover{color:var(--jsie-text)}\n.jsie-rpanel-tab.active{color:var(--jsie-accent);border-bottom-color:var(--jsie-accent)}\n.jsie-rpanel-content{display:none;flex-direction:column;flex:1;overflow:hidden}\n.jsie-rpanel-content.active{display:flex}\n.jsie-filters-vertical{flex:1;overflow-y:auto;padding:8px 10px;display:flex;flex-direction:column;gap:10px}\n.jsie-filters-vertical .jsie-filter-item{display:flex;flex-direction:column;gap:3px;font-size:11px;color:var(--jsie-text2)}\n.jsie-filters-vertical .jsie-filter-item .jsie-filter-row{display:flex;align-items:center;gap:6px}\n.jsie-filters-vertical .jsie-filter-item input[type="range"]{flex:1;height:4px;-webkit-appearance:none;appearance:none;background:var(--jsie-slider-track);border-radius:2px;outline:none;cursor:pointer}\n.jsie-filters-vertical .jsie-filter-item input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--jsie-slider-thumb);cursor:pointer;border:2px solid var(--jsie-bg)}\n.jsie-filters-vertical .jsie-filter-item input[type="range"]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--jsie-slider-thumb);cursor:pointer;border:2px solid var(--jsie-bg)}\n.jsie-filters-vertical .jsie-filter-val{width:30px;text-align:right;font-variant-numeric:tabular-nums}\n.jsie-layers-header{padding:8px 10px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--jsie-border);color:var(--jsie-text2)}\n.jsie-layers-controls{padding:6px 10px;display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--jsie-border);font-size:11px}\n.jsie-layers-controls label{color:var(--jsie-text2);white-space:nowrap;font-size:10px}\n.jsie-layers-controls input[type="range"]{flex:1;height:4px;-webkit-appearance:none;appearance:none;background:var(--jsie-slider-track);border-radius:2px;outline:none;cursor:pointer}\n.jsie-layers-controls input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--jsie-slider-thumb);cursor:pointer;border:2px solid var(--jsie-bg)}\n.jsie-layers-controls input[type="range"]::-moz-range-thumb{width:12px;height:12px;border-radius:50%;background:var(--jsie-slider-thumb);cursor:pointer;border:2px solid var(--jsie-bg)}\n.jsie-layer-opacity-val{width:30px;text-align:right;font-size:10px;font-variant-numeric:tabular-nums;color:var(--jsie-text2)}\n.jsie-blend-select{flex:1;height:22px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 4px;font-size:10px}\n\n/* Group layers */\n.jsie-layer-item.group-item{background:var(--jsie-bg3)}\n.jsie-layer-group-toggle{width:16px;height:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;opacity:.7}\n.jsie-layer-group-toggle:hover{opacity:1}\n.jsie-layer-group-toggle svg{width:14px;height:14px;fill:currentColor}\n.jsie-layer-item.group-child{padding-left:22px}\n.jsie-layer-text-icon{width:40px;height:30px;display:flex;align-items:center;justify-content:center;border:1px solid var(--jsie-border);border-radius:2px;background:var(--jsie-bg3);font-weight:700;font-size:16px;flex-shrink:0;color:var(--jsie-text)}\n\n/* Layer list */\n.jsie-layers-list{flex:1;overflow-y:auto;padding:2px 0}\n.jsie-layer-item{display:flex;align-items:center;gap:6px;padding:4px 6px;cursor:pointer;border:2px solid transparent;min-height:40px;transition:background .1s}\n.jsie-layer-item:hover{background:var(--jsie-hover)}\n.jsie-layer-item.active{background:var(--jsie-layer-active);border-color:var(--jsie-accent)}\n.jsie-layer-item.drag-over{border-top:2px solid var(--jsie-accent)}\n.jsie-layer-vis{width:18px;height:18px;cursor:pointer;opacity:.7;flex-shrink:0;display:flex;align-items:center;justify-content:center}\n.jsie-layer-vis:hover{opacity:1}\n.jsie-layer-vis.hidden{opacity:.3}\n.jsie-layer-vis svg{width:16px;height:16px;fill:currentColor}\n.jsie-layer-thumb{width:40px;height:30px;border:1px solid var(--jsie-border);border-radius:2px;background:repeating-conic-gradient(#808080 0% 25%,#a0a0a0 0% 50%) 50%/8px 8px;flex-shrink:0;overflow:hidden}\n.jsie-layer-thumb img{width:100%;height:100%;object-fit:contain}\n.jsie-layer-name{flex:1;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}\n.jsie-layer-name-input{flex:1;font-size:11px;background:var(--jsie-input-bg);border:1px solid var(--jsie-accent);color:var(--jsie-text);border-radius:2px;padding:1px 4px;outline:none}\n\n/* Layer actions */\n.jsie-layers-actions{display:flex;justify-content:center;gap:2px;padding:4px;border-top:1px solid var(--jsie-border)}\n.jsie-layers-actions .jsie-btn{width:28px;height:28px}\n.jsie-layers-actions .jsie-btn svg{width:16px;height:16px}\n\n/* Filters bar */\n.jsie-filters{display:flex;gap:12px;padding:6px 12px;background:var(--jsie-bg2);border-top:1px solid var(--jsie-border);flex-wrap:wrap;align-items:center}\n.jsie-filter-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--jsie-text2)}\n.jsie-filter-item input[type="range"]{width:80px;height:4px;-webkit-appearance:none;appearance:none;background:var(--jsie-slider-track);border-radius:2px;outline:none;cursor:pointer}\n.jsie-filter-item input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--jsie-slider-thumb);cursor:pointer;border:2px solid var(--jsie-bg)}\n.jsie-filter-item input[type="range"]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--jsie-slider-thumb);cursor:pointer;border:2px solid var(--jsie-bg)}\n.jsie-filter-item .jsie-filter-val{width:30px;text-align:right;font-variant-numeric:tabular-nums}\n\n/* Status bar */\n.jsie-status-bar{display:flex;align-items:center;gap:16px;padding:2px 10px;background:var(--jsie-bg2);border-top:1px solid var(--jsie-border);font-size:10px;color:var(--jsie-text2);min-height:20px}\n\n/* Empty state */\n.jsie-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--jsie-text2);cursor:pointer;border:2px dashed var(--jsie-border);border-radius:8px;padding:40px;margin:20px;text-align:center}\n.jsie-empty svg{width:48px;height:48px;fill:var(--jsie-text2);opacity:.5}\n.jsie-empty:hover{border-color:var(--jsie-accent);color:var(--jsie-accent)}\n.jsie-empty:hover svg{fill:var(--jsie-accent);opacity:.7}\n\n/* Crop overlay */\n.jsie-crop-overlay{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10}\n.jsie-crop-overlay .jsie-crop-rect{position:absolute;border:2px solid #fff;box-shadow:0 0 0 9999px rgba(0,0,0,0.5);cursor:move}\n.jsie-crop-overlay .jsie-crop-handle{position:absolute;width:10px;height:10px;background:#fff;border:1px solid #333}\n.jsie-crop-overlay .jsie-crop-handle.tl{top:-5px;left:-5px;cursor:nw-resize}\n.jsie-crop-overlay .jsie-crop-handle.tr{top:-5px;right:-5px;cursor:ne-resize}\n.jsie-crop-overlay .jsie-crop-handle.bl{bottom:-5px;left:-5px;cursor:sw-resize}\n.jsie-crop-overlay .jsie-crop-handle.br{bottom:-5px;right:-5px;cursor:se-resize}\n\n/* Resize panel */\n.jsie-resize-panel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--jsie-bg2);border:1px solid var(--jsie-border);border-radius:8px;padding:16px;z-index:10;display:flex;flex-direction:column;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,0.4)}\n.jsie-resize-panel label{font-size:12px;color:var(--jsie-text)}\n.jsie-resize-panel input[type="number"]{width:80px;height:28px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 6px;font-size:12px}\n.jsie-resize-panel .jsie-row{display:flex;gap:8px;align-items:center}\n.jsie-resize-panel .jsie-checkbox-row{display:flex;align-items:center;gap:6px}\n.jsie-resize-panel .jsie-checkbox-row input[type="checkbox"]{width:auto;height:auto}\n\n/* Text input overlay */\n.jsie-text-input-overlay{position:absolute;z-index:10}\n.jsie-text-input-overlay textarea{background:transparent;border:1px dashed var(--jsie-accent);color:var(--jsie-text);font-family:inherit;padding:2px 4px;resize:both;min-width:60px;min-height:24px;outline:none}\n\n/* Modal */\n.jsie-modal-overlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}\n.jsie-modal-content{width:90vw;height:90vh;border-radius:8px;overflow:hidden}\n',document.head.appendChild(e)}}render(){this.root=document.createElement("div"),this.root.className=`jsie-editor theme-${this.config.theme}`,this.root.style.width=this.config.width,this.root.style.height=this.config.height,this.root.innerHTML=function(e){const t=e.tools||{},i=t.drawing||["move","pencil","eraser","eyedropper","fill","gradient","rect","circle","line","arrow","text"],s=t.transform||["crop","resize","rotateLeft","rotateRight","flipH","flipV"],o=e.panels||{},a=!1!==o.layers,l=!1!==o.filters,c=!1!==o.statusBar,h=e.filters||["brightness","contrast","saturation","blur","grayscale","sepia","hue"],d={brightness:{min:0,max:200,value:100},contrast:{min:0,max:200,value:100},saturation:{min:0,max:200,value:100},blur:{min:0,max:20,value:0},grayscale:{min:0,max:100,value:0},sepia:{min:0,max:100,value:0},hue:{min:0,max:360,value:0}},p=i.map(e=>{if("object"==typeof e&&e.group){const t=e.tools[0];return`<div class="jsie-tool-group" data-group="${e.group}">\n          <button class="jsie-tool-btn" data-tool="${t}" data-group="${e.group}" title="${r("tool."+t)}">\n            ${n[t]||""}\n            <span class="jsie-group-arrow"></span>\n          </button>\n        </div>`}return`<button class="jsie-tool-btn" data-tool="${e}" title="${r("tool."+e)}">${n[e]||""}</button>`}).join(""),u=["resize","rotateLeft","rotateRight","flipH","flipV"],g=s.map(e=>{if("object"==typeof e&&e.group){const t=e.tools[0];return`<div class="jsie-tool-group jsie-action-group" data-group="${e.group}">\n          <button class="jsie-tool-btn" data-action="${t}" data-group="${e.group}" title="${r("tool."+t)}">\n            ${n[t]||""}\n            <span class="jsie-group-arrow"></span>\n          </button>\n        </div>`}return`<button class="jsie-tool-btn" ${u.includes(e)?`data-action="${e}"`:`data-tool="${e}"`} title="${r("tool."+e)}">${n[e]||""}</button>`}).join("");return`\n<div class="jsie-menubar">\n  <div class="jsie-menu-item" data-menu="file">${r("menu.file")}</div>\n  <div class="jsie-menu-item" data-menu="edit">${r("menu.edit")}</div>\n  <div class="jsie-menu-item" data-menu="image">${r("menu.image")}</div>\n  <div class="jsie-menu-item" data-menu="layer">${r("menu.layer")}</div>\n  <div class="jsie-menu-item" data-menu="select">${r("menu.select")}</div>\n  <div class="jsie-menu-item" data-menu="view">${r("menu.view")}</div>\n  <div class="jsie-menu-item" data-menu="help">${r("menu.help")}</div>\n</div>\n<div class="jsie-options-bar">\n  <div class="jsie-options-left">\n    <button class="jsie-btn" data-action="undo" title="${r("tool.undo")}">${n.undo}</button>\n    <button class="jsie-btn" data-action="redo" title="${r("tool.redo")}">${n.redo}</button>\n    <div class="jsie-sep"></div>\n    <div class="jsie-tool-options" id="jsie-tool-options"></div>\n  </div>\n  <div class="jsie-options-right">\n    <button class="jsie-btn-text secondary" data-action="import">${n.importImg} ${r("btn.import")}</button>\n    <button class="jsie-btn-text secondary" data-action="export">${n.download} ${r("btn.export")}</button>\n    <div class="jsie-sep"></div>\n    <button class="jsie-btn-text secondary" data-action="reset">${n.reset} ${r("btn.reset")}</button>\n    <button class="jsie-btn-text secondary" data-action="cancel">${n.cancel} ${r("btn.cancel")}</button>\n    <button class="jsie-btn-text" data-action="save">${n.save} ${r("btn.save")}</button>\n  </div>\n</div>\n\n<div class="jsie-main-body">\n  <div class="jsie-toolbox">\n    ${p}\n    <div class="jsie-tool-sep"></div>\n    ${g}\n    <div class="jsie-tool-sep"></div>\n    <button class="jsie-tool-btn" data-action="zoomIn" title="${r("tool.zoomIn")}">${n.zoomIn}</button>\n    <button class="jsie-tool-btn" data-action="zoomOut" title="${r("tool.zoomOut")}">${n.zoomOut}</button>\n    <button class="jsie-tool-btn" data-action="zoomFit" title="${r("tool.zoomFit")}">${n.zoomFit}</button>\n  </div>\n\n  <div class="jsie-canvas-area" id="jsie-canvas-area">\n    <div class="jsie-canvas-wrap" id="jsie-canvas-wrap" style="display:none">\n      <canvas id="jsie-main-canvas"></canvas>\n    </div>\n    <div class="jsie-empty" id="jsie-empty">\n      ${n.upload}\n      <span>${r("empty.loadImage")}</span>\n      <input type="file" accept="image/*,.shoimg" id="jsie-file-input" style="display:none">\n    </div>\n  </div>\n\n  ${a||l?`\n  <div class="jsie-layers-panel" id="jsie-layers-panel">\n    ${a&&l?`<div class="jsie-rpanel-tabs">\n      <button type="button" class="jsie-rpanel-tab active" data-rpanel="layers">${r("panel.layers")}</button>\n      <button type="button" class="jsie-rpanel-tab" data-rpanel="image">${r("panel.image")}</button>\n    </div>`:""}\n    ${a?`<div class="jsie-rpanel-content${!l||a&&l?" active":""}" data-rpanel-content="layers">\n    <div class="jsie-layers-controls">\n      <label>${r("opt.blendMode")}</label>\n      <select id="jsie-layer-blend" class="jsie-blend-select">\n        <option value="normal">Normal</option>\n        <option value="multiply">Multiply</option>\n        <option value="screen">Screen</option>\n        <option value="overlay">Overlay</option>\n        <option value="darken">Darken</option>\n        <option value="lighten">Lighten</option>\n        <option value="color-dodge">Color Dodge</option>\n        <option value="color-burn">Color Burn</option>\n        <option value="hard-light">Hard Light</option>\n        <option value="soft-light">Soft Light</option>\n        <option value="difference">Difference</option>\n        <option value="exclusion">Exclusion</option>\n      </select>\n    </div>\n    <div class="jsie-layers-controls">\n      <label>${r("opt.opacity")}</label>\n      <input type="range" id="jsie-layer-opacity" min="0" max="100" value="100">\n      <span id="jsie-layer-opacity-val" class="jsie-layer-opacity-val">100%</span>\n    </div>\n    <div class="jsie-layers-list" id="jsie-layers-list"></div>\n    <div class="jsie-layers-actions">\n      <button class="jsie-btn" data-layer-action="add" title="${r("layer.add")}">${n.layerAdd}</button>\n      <button class="jsie-btn" data-layer-action="group" title="${r("layer.group")}">${n.folder}</button>\n      <button class="jsie-btn" data-layer-action="delete" title="${r("layer.delete")}">${n.layerDelete}</button>\n      <button class="jsie-btn" data-layer-action="duplicate" title="${r("layer.duplicate")}">${n.layerDup}</button>\n      <button class="jsie-btn" data-action="layerStyles" title="${r("layer.styles")}">${n.layerStyles}</button>\n    </div>\n    </div>`:""}\n    ${l?`<div class="jsie-rpanel-content${a?"":" active"}" data-rpanel-content="image">\n      <div class="jsie-filters-vertical">${h.map(e=>{const t=d[e]||{min:0,max:100,value:0};return`<div class="jsie-filter-item"><span>${r("filter."+e)}</span><div class="jsie-filter-row"><input type="range" data-filter="${e}" min="${t.min}" max="${t.max}" value="${t.value}"><span class="jsie-filter-val">${t.value}</span></div></div>`}).join("")}</div>\n    </div>`:""}\n  </div>`:""}\n</div>\n${c?'<div class="jsie-status-bar"><span id="jsie-status-dims"></span><span id="jsie-status-cursor"></span><span id="jsie-status-tool"></span><span id="jsie-status-zoom" style="margin-left:auto"></span></div>':""}`}(this.config),this.container.appendChild(this.root)}cacheElements(){this.mainCanvas=t("#jsie-main-canvas",this.root),this.mainCtx=this.mainCanvas.getContext("2d"),this.canvasWrap=t("#jsie-canvas-wrap",this.root),this.canvasArea=t("#jsie-canvas-area",this.root),this.emptyState=t("#jsie-empty",this.root),this.fileInput=t("#jsie-file-input",this.root),this.toolOptions=t("#jsie-tool-options",this.root),this.layersList=t("#jsie-layers-list",this.root),this.layerOpacitySlider=t("#jsie-layer-opacity",this.root),this.layerOpacityVal=t("#jsie-layer-opacity-val",this.root),this.layerBlendSelect=t("#jsie-layer-blend",this.root),this.statusDims=t("#jsie-status-dims",this.root),this.statusCursor=t("#jsie-status-cursor",this.root),this.statusTool=t("#jsie-status-tool",this.root),this.statusZoom=t("#jsie-status-zoom",this.root),this.interactionCanvas=document.createElement("canvas"),this.interactionCanvas.className="jsie-interaction-canvas",this.interactionCanvas.style.cursor="default"}bindEvents(){const e=this.root;s(e,"click",".jsie-menu-item",(e,t)=>{const i=t.dataset.menu;this._menuOpen===i?this._closeMenus():this._openMenu(i,t),e.stopPropagation()}),s(e,"mouseenter",".jsie-menu-item",(e,t)=>{this._menuOpen&&this._menuOpen!==t.dataset.menu&&this._openMenu(t.dataset.menu,t)}),s(e,"click",".jsie-menu-entry[data-maction]",(e,t)=>{e.stopPropagation(),this._handleMenuAction(t.dataset.maction,t.dataset.mparam)}),s(e,"click",".jsie-menu-entry[data-mtool]",(e,t)=>{e.stopPropagation();const i=t.dataset.mtool;this.setTool(i),this._closeMenus()}),s(e,"mouseenter",".jsie-menu-has-sub",(t,s)=>{i(".jsie-menu-submenu",e).forEach(e=>e.remove());const o=s.dataset.submenu,a=this._buildMenuDropdown(o);if(!a)return;const r=document.createElement("div");r.className="jsie-menu-submenu",r.innerHTML=a,s.appendChild(r);const n=r.getBoundingClientRect();n.right>window.innerWidth&&(r.style.left="auto",r.style.right="100%"),n.bottom>window.innerHeight&&(r.style.top="auto",r.style.bottom="0")}),this._closeMenuOnOutside=e=>{this._menuOpen&&!e.target.closest(".jsie-menubar")&&this._closeMenus()},document.addEventListener("mousedown",this._closeMenuOnOutside),s(e,"keydown",e=>{"Escape"===e.key&&this._menuOpen&&this._closeMenus()}),s(e,"click","[data-action]",(e,t)=>{if(e.target.closest(".jsie-group-arrow"))return;if(t._longPressed)return void(t._longPressed=!1);const i=t.dataset.action;"undo"===i?this.undo():"redo"===i?this.redo():"rotateLeft"===i?this.rotate(-90):"rotateRight"===i?this.rotate(90):"flipH"===i?this.flip("horizontal"):"flipV"===i?this.flip("vertical"):"resize"===i?this.showResizePanel():"zoomIn"===i?this._zoom(1.25):"zoomOut"===i?this._zoom(.8):"zoomFit"===i?this._zoomFit():"import"===i?this._triggerImport():"export"===i?this._showExportDialog():"layerStyles"===i?this._showLayerStylesDialog():"reset"===i?this.reset():"cancel"===i?this._onCancel():"save"===i&&this._onSave()}),s(e,"click",".jsie-tool-btn[data-tool]",(e,t)=>{if(e.target.closest(".jsie-group-arrow"))return;if(t._longPressed)return void(t._longPressed=!1);const i=t.dataset.tool;this.setTool(i===this.currentTool?null:i)}),s(e,"click",".jsie-group-arrow",(e,t)=>{e.stopPropagation();const i=t.closest(".jsie-tool-group");i&&this._toggleGroupSubmenu(i.dataset.group,i)}),s(e,"mousedown",".jsie-tool-group > .jsie-tool-btn",(e,t)=>{if(e.target.closest(".jsie-group-arrow"))return;const i=t.closest(".jsie-tool-group");i&&(t._longPressTimer=setTimeout(()=>{t._longPressed=!0,this._toggleGroupSubmenu(i.dataset.group,i)},1e3))}),s(e,"mouseup",".jsie-tool-group > .jsie-tool-btn",(e,t)=>{clearTimeout(t._longPressTimer)}),s(e,"mouseleave",".jsie-tool-group > .jsie-tool-btn",(e,t)=>{clearTimeout(t._longPressTimer)}),this._closeGroupSubmenu=e=>{e.target.closest(".jsie-group-submenu")||e.target.closest(".jsie-group-arrow")||i(".jsie-group-submenu",this.root).forEach(e=>e.remove())},document.addEventListener("click",this._closeGroupSubmenu),s(e,"click",".jsie-rpanel-tab",(t,s)=>{const o=s.dataset.rpanel;i(".jsie-rpanel-tab",e).forEach(e=>e.classList.toggle("active",e===s)),i(".jsie-rpanel-content",e).forEach(e=>e.classList.toggle("active",e.dataset.rpanelContent===o))}),s(e,"input","input[data-filter]",(e,t)=>{const i=t.dataset.filter;this.filters[i]=parseFloat(t.value),t.nextElementSibling.textContent=t.value,this._applyFilters()}),s(this.emptyState,"click",()=>this.fileInput.click()),s(this.fileInput,"change",()=>{const e=this.fileInput.files[0];e&&e.name.endsWith(".shoimg")?this.openProject(e):e&&this.loadImage(e)}),s(this.canvasArea,"dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"}),s(this.canvasArea,"drop",e=>{e.preventDefault();const t=e.dataTransfer.files?.[0];t&&t.name.endsWith(".shoimg")?this.openProject(t):t&&t.type.startsWith("image/")&&(this.layerManager?this.importAsLayer(t):this.loadImage(t))}),this._bindLayerEvents(),this._bindCanvasEvents(),this._keyHandler=e=>{if(!this.layerManager)return;if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||"SELECT"===e.target.tagName)return;const t=e.ctrlKey||e.metaKey;t&&"z"===e.key&&!e.shiftKey?(e.preventDefault(),this.undo()):t&&("y"===e.key||"z"===e.key&&e.shiftKey)?(e.preventDefault(),this.redo()):t&&"a"===e.key?(e.preventDefault(),this._selectAll()):t&&"d"===e.key?(e.preventDefault(),this._clearSelection()):t&&e.shiftKey&&("I"===e.key||"i"===e.key)?(e.preventDefault(),this._invertSelection()):t&&"c"===e.key?this.selection&&(e.preventDefault(),this._copySelection()):t&&"x"===e.key?this.selection&&(e.preventDefault(),this._cutSelection()):t&&"v"===e.key?this._clipboard&&(e.preventDefault(),this._pasteSelection()):"Delete"===e.key||"Backspace"===e.key?this.selection&&(e.preventDefault(),this._deleteSelection()):"Escape"===e.key&&(this.selection?this._clearSelection():this._selectionPoints.length>0&&(this._selectionPoints=[],this._stopMarchingAnts()))},document.addEventListener("keydown",this._keyHandler)}_bindLayerEvents(){this.layersList&&(s(this.layersList,"click",".jsie-layer-item",(e,t)=>{if(e.target.closest(".jsie-layer-vis")||e.target.closest(".jsie-layer-group-toggle"))return;const i=parseInt(t.dataset.layerId);this.layerManager.setActive(i),this._renderLayersList(),this._updateLayerOpacityUI(),this._redraw();const s=this._findLayerById(i);s&&"text"===s.type&&s.textData&&(this.setTool("text"),this._loadTextLayerProps(s))}),this.layersList.addEventListener("contextmenu",e=>{e.preventDefault();const i=e.target.closest(".jsie-layer-item");if(!i)return;const s=parseInt(i.dataset.layerId),o=this._findLayerById(s);if(!o)return;const a=t(".jsie-layer-ctx",this.root);a&&a.remove(),this.layerManager.setActive(s),this._renderLayersList(),this._updateLayerOpacityUI();const n=document.createElement("div");n.className="jsie-layer-ctx",n.style.cssText=`position:fixed;left:${e.clientX}px;top:${e.clientY}px;z-index:10002;background:var(--jsie-bg);border:1px solid var(--jsie-border);border-radius:4px;padding:4px 0;min-width:150px;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-size:12px`;const l="group"!==o.type;[{label:r("layer.styles"),action:"styles",disabled:!l},{label:r("layer.resize"),action:"resizeLayer",disabled:!l},{label:r("layer.duplicate"),action:"duplicate"},{label:r("layer.delete"),action:"delete"}].forEach(e=>{const t=document.createElement("div");t.textContent=e.label,t.style.cssText="padding:6px 14px;cursor:pointer;color:var(--jsie-text)"+(e.disabled?";opacity:0.4;pointer-events:none":""),t.addEventListener("mouseenter",()=>{e.disabled||(t.style.background="var(--jsie-hover)")}),t.addEventListener("mouseleave",()=>t.style.background=""),t.addEventListener("click",()=>{n.remove(),"styles"===e.action?this._showLayerStylesDialog():"resizeLayer"===e.action?this._showResizeLayerDialog(o):"duplicate"===e.action?(this.layerManager.duplicateLayer(s),this.pushHistory(),this._redraw(),this._renderLayersList()):"delete"===e.action&&(this.layerManager.removeLayer(s),this.pushHistory(),this._redraw(),this._renderLayersList(),this._updateLayerOpacityUI())}),n.appendChild(t)}),this.root.appendChild(n);const c=e=>{n.contains(e.target)||(n.remove(),document.removeEventListener("mousedown",c,!0))};setTimeout(()=>document.addEventListener("mousedown",c,!0),0)}),s(this.layersList,"click",".jsie-layer-vis",(e,t)=>{e.stopPropagation();const i=parseInt(t.dataset.layerVis),s=this._findLayerById(i);s&&(s.visible=!s.visible,this._redraw(),this._renderLayersList())}),s(this.layersList,"click",".jsie-layer-group-toggle",(e,t)=>{e.stopPropagation();const i=parseInt(t.dataset.groupToggle),s=this.layerManager.layers.find(e=>e.id===i);s&&"group"===s.type&&(s.collapsed=!s.collapsed,this._renderLayersList())}),s(this.layersList,"dblclick",".jsie-layer-text-icon",(e,t)=>{const i=t.closest(".jsie-layer-item"),s=parseInt(i.dataset.layerId),o=this._findLayerById(s);o&&"text"===o.type&&(this.layerManager.setActive(s),this._editTextLayer(o))}),s(this.layersList,"dblclick",".jsie-layer-name",(e,t)=>{const i=t.closest(".jsie-layer-item"),s=parseInt(i.dataset.layerId),o=this._findLayerById(s);if(!o)return;const a=document.createElement("input");a.className="jsie-layer-name-input",a.value=o.name,t.replaceWith(a),a.focus(),a.select();const r=()=>{o.name=a.value||o.name,this._renderLayersList()};a.addEventListener("blur",r),a.addEventListener("keydown",e=>{"Enter"===e.key&&r(),"Escape"===e.key&&this._renderLayersList()})}),this.layerBlendSelect&&s(this.layerBlendSelect,"change",()=>{this.layerManager&&this.layerManager.activeLayer&&(this.layerManager.activeLayer.blendMode=this.layerBlendSelect.value,this._redraw())}),this.layerOpacitySlider&&s(this.layerOpacitySlider,"input",()=>{const e=parseInt(this.layerOpacitySlider.value);this.layerManager&&this.layerManager.activeLayer&&(this.layerManager.setOpacity(this.layerManager.activeLayerId,e/100),this.layerOpacityVal.textContent=e+"%",this._redraw(),this._scheduleThumbnailUpdate())}),s(this.root,"click","[data-layer-action]",(e,t)=>{if(!this.layerManager)return;const i=t.dataset.layerAction;"add"===i?(this.layerManager.addLayer(),this.pushHistory(),this._redraw(),this._renderLayersList()):"group"===i?(this.layerManager.addGroup(),this.pushHistory(),this._redraw(),this._renderLayersList()):"delete"===i?(this.layerManager.deleteLayer(this.layerManager.activeLayerId),this.pushHistory(),this._redraw(),this._renderLayersList()):"duplicate"===i&&(this.layerManager.duplicateLayer(this.layerManager.activeLayerId),this.pushHistory(),this._redraw(),this._renderLayersList())}),this._bindLayerDragEvents())}_bindLayerDragEvents(){if(!this.layersList)return;let e=null;this.layersList.addEventListener("dragstart",t=>{const i=t.target.closest(".jsie-layer-item");i&&(e=parseInt(i.dataset.layerId),t.dataTransfer.effectAllowed="move",requestAnimationFrame(()=>i.style.opacity="0.4"))}),this.layersList.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".jsie-layer-item");this.layersList.querySelectorAll(".drag-over").forEach(e=>e.classList.remove("drag-over")),t&&t.classList.add("drag-over")}),this.layersList.addEventListener("drop",t=>{t.preventDefault(),this.layersList.querySelectorAll(".drag-over").forEach(e=>e.classList.remove("drag-over"));const i=t.target.closest(".jsie-layer-item");if(!i||null===e)return;const s=parseInt(i.dataset.layerId),o=this._findLayerById(s),a=this.layerManager.layers;if(o&&"group"===o.type&&e!==s)this.layerManager.moveToGroup(e,s),this.pushHistory(),this._redraw(),this._renderLayersList();else{const t=a.findIndex(t=>t.id===e),i=a.findIndex(e=>e.id===s);-1!==t&&-1!==i&&t!==i&&(this.layerManager.moveLayer(t,i),this.pushHistory(),this._redraw(),this._renderLayersList())}e=null}),this.layersList.addEventListener("dragend",()=>{this.layersList.querySelectorAll(".jsie-layer-item").forEach(e=>e.style.opacity=""),e=null})}_bindCanvasEvents(){const e=this.interactionCanvas;e.addEventListener("mousedown",t=>{if(!this.layerManager)return;{const e=this._canvasPos(t);if(this.layerManager.activeLayer){const e=this._getLayerContentBounds(this.layerManager.activeLayer);e&&(this._lastLayerBounds=e)}const i=this._hitTestHandle(e);if(i)return void this._startVisualResize(i,e,t)}if(!this.currentTool)return;if("pan"===this.currentTool){t.preventDefault();const i=this.canvasArea,s=t.clientX,o=t.clientY,a=i.scrollLeft,r=i.scrollTop;e.style.cursor="grabbing";const n=e=>{i.scrollLeft=a-(e.clientX-s),i.scrollTop=r-(e.clientY-o)},l=()=>{e.style.cursor="grab",document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",l)};return document.addEventListener("mousemove",n),void document.addEventListener("mouseup",l)}const i=this.layerManager.activeLayer;if(!i)return;this.drawing=!0;const s=this._canvasPos(t),o=i.ctx;if("selectRect"===this.currentTool||"selectEllipse"===this.currentTool)return this.drawing=!0,this._selectionStart=s,void(this._selectionPreview=null);if("selectPoly"===this.currentTool){if(this.drawing=!1,this._selectionPoints.length>2){const e=this._selectionPoints[0];if(Math.hypot(s.x-e.x,s.y-e.y)<8)return void this._finalizePolySelection()}return this._selectionPoints.push({x:s.x,y:s.y}),void this._drawPolyPreview(s)}if("selectFree"===this.currentTool)return this.drawing=!0,void(this._selectionPoints=[{x:s.x,y:s.y}]);if("selectWand"===this.currentTool)return this.drawing=!1,void this._magicWandSelect(s.x,s.y);if("move"===this.currentTool)this._moveStart=s,this._moveSnapshot=o.getImageData(0,0,i.width,i.height);else if("eyedropper"===this.currentTool)this.drawing=!1,this._pickColor(s);else if("fill"===this.currentTool)this.drawing=!1,this._floodFill(i,Math.round(s.x),Math.round(s.y),this.drawColor,this.fillTolerance),this.pushHistory(),this._redraw(),this._scheduleThumbnailUpdate();else if("gradient"===this.currentTool)this.shapeStart=s,this._shapeSnapshot=o.getImageData(0,0,i.width,i.height);else if("pencil"===this.currentTool||"eraser"===this.currentTool)o.beginPath(),o.moveTo(s.x,s.y),o.globalCompositeOperation="eraser"===this.currentTool?"destination-out":"source-over",o.strokeStyle=this.drawColor,o.lineWidth=this.strokeSize,o.lineCap="round",o.lineJoin="round";else if("text"===this.currentTool){this.drawing=!1;const e=this._findTextLayerAt(s);e?(this.layerManager.setActive(e.id),this._loadTextLayerProps(e),this._renderLayersList(),this._redraw()):this._placeText(s)}else"crop"===this.currentTool?this.drawing=!1:(this.shapeStart=s,this._shapeSnapshot=o.getImageData(0,0,i.width,i.height))}),e.addEventListener("mousemove",t=>{const i=this._canvasPos(t);this._updateStatusCursor(i);const s=this._hitTestHandle(i);if(s&&!this.drawing){const t={tl:"nw-resize",tc:"n-resize",tr:"ne-resize",ml:"w-resize",mc:"move",mr:"e-resize",bl:"sw-resize",bc:"s-resize",br:"se-resize"};e.style.cursor=t[s]||"default"}else this.drawing||(e.style.cursor="");if("selectPoly"===this.currentTool&&this._selectionPoints.length>0)return void this._drawPolyPreview(i);if(!this.drawing||!this.currentTool)return;if("selectRect"===this.currentTool&&this._selectionStart){const e=Math.min(this._selectionStart.x,i.x),s=Math.min(this._selectionStart.y,i.y),o=Math.abs(i.x-this._selectionStart.x),a=Math.abs(i.y-this._selectionStart.y);if(t.shiftKey){const t=Math.max(o,a);this._selectionPreview={type:"rect",x:e,y:s,width:t,height:t}}else this._selectionPreview={type:"rect",x:e,y:s,width:o,height:a};const r=new Path2D;return r.rect(this._selectionPreview.x,this._selectionPreview.y,this._selectionPreview.width,this._selectionPreview.height),void this._drawSelectionPreview(r)}if("selectEllipse"===this.currentTool&&this._selectionStart){const e=(this._selectionStart.x+i.x)/2,s=(this._selectionStart.y+i.y)/2;let o=Math.abs(i.x-this._selectionStart.x)/2,a=Math.abs(i.y-this._selectionStart.y)/2;if(t.shiftKey){const e=Math.max(o,a);o=e,a=e}this._selectionPreview={type:"ellipse",cx:e,cy:s,rx:o,ry:a};const r=new Path2D;return r.ellipse(e,s,Math.max(1,o),Math.max(1,a),0,0,2*Math.PI),void this._drawSelectionPreview(r)}if("selectFree"===this.currentTool){this._selectionPoints.push({x:i.x,y:i.y});const e=new Path2D;e.moveTo(this._selectionPoints[0].x,this._selectionPoints[0].y);for(let t=1;t<this._selectionPoints.length;t++)e.lineTo(this._selectionPoints[t].x,this._selectionPoints[t].y);return void this._drawSelectionPreview(e)}const o=this.layerManager.activeLayer;if(!o)return;const a=o.ctx;if("move"===this.currentTool){if(this._moveSnapshot&&this._moveStart){const e=i.x-this._moveStart.x,t=i.y-this._moveStart.y;a.clearRect(0,0,o.width,o.height),a.putImageData(this._moveSnapshot,e,t),this._redraw()}}else"gradient"===this.currentTool?this._shapeSnapshot&&this.shapeStart&&(a.putImageData(this._shapeSnapshot,0,0),this._drawGradientPreview(a,this.shapeStart,i),this._redraw()):"pencil"===this.currentTool||"eraser"===this.currentTool?(a.lineTo(i.x,i.y),a.stroke(),this._redraw()):this.shapeStart&&(a.putImageData(this._shapeSnapshot,0,0),this._drawShape(this.currentTool,this.shapeStart,i,a),this._redraw())}),e.addEventListener("mouseup",e=>{if("selectRect"===this.currentTool&&this.drawing&&this._selectionPreview)return this.drawing=!1,this._selectionPreview.width>1&&this._selectionPreview.height>1&&(this.selection=this._selectionPreview,this._buildSelectionPath(),this._startMarchingAnts()),this._selectionPreview=null,void(this._selectionStart=null);if("selectEllipse"===this.currentTool&&this.drawing&&this._selectionPreview)return this.drawing=!1,this._selectionPreview.rx>1&&this._selectionPreview.ry>1&&(this.selection=this._selectionPreview,this._buildSelectionPath(),this._startMarchingAnts()),this._selectionPreview=null,void(this._selectionStart=null);if("selectFree"===this.currentTool&&this.drawing)return this.drawing=!1,void(this._selectionPoints.length>2?(this.selection={type:"free",points:[...this._selectionPoints]},this._selectionPoints=[],this._buildSelectionPath(),this._startMarchingAnts()):(this._selectionPoints=[],this._stopMarchingAnts()));if(!this.drawing)return;this.drawing=!1;const t=this.layerManager?this.layerManager.activeLayer:null;if(t)if("move"===this.currentTool){if("text"===t.type&&t.textData&&this._moveStart){const i=this._canvasPos(e),s=i.x-this._moveStart.x,o=i.y-this._moveStart.y;t.textData.x=(t.textData.x||0)+s,t.textData.y=(t.textData.y||0)+o}this._moveSnapshot=null,this._moveStart=null,this.pushHistory(),this._redraw(),this._scheduleThumbnailUpdate()}else if("gradient"===this.currentTool){if(this._shapeSnapshot&&this.shapeStart){const i=this._canvasPos(e);t.ctx.putImageData(this._shapeSnapshot,0,0),this._applyGradient(t.ctx,this.shapeStart,i),this.shapeStart=null,this._shapeSnapshot=null,this.pushHistory(),this._redraw(),this._scheduleThumbnailUpdate()}}else if("pencil"===this.currentTool||"eraser"===this.currentTool)t.ctx.globalCompositeOperation="source-over",this.pushHistory(),this._redraw(),this._scheduleThumbnailUpdate();else if(this.shapeStart){const i=this._canvasPos(e);t.ctx.putImageData(this._shapeSnapshot,0,0),this._drawShape(this.currentTool,this.shapeStart,i,t.ctx),this.shapeStart=null,this._shapeSnapshot=null,this.pushHistory(),this._redraw(),this._scheduleThumbnailUpdate()}}),e.addEventListener("mouseleave",()=>{if(this.drawing&&("pencil"===this.currentTool||"eraser"===this.currentTool)){this.drawing=!1;const e=this.layerManager?this.layerManager.activeLayer:null;e&&(e.ctx.globalCompositeOperation="source-over"),this.pushHistory(),this._redraw(),this._scheduleThumbnailUpdate()}this.drawing&&"move"===this.currentTool&&(this.drawing=!1,this._moveSnapshot=null,this._moveStart=null,this.pushHistory(),this._redraw(),this._scheduleThumbnailUpdate())}),e.addEventListener("wheel",e=>{e.preventDefault(),this._zoom(e.deltaY<0?1.1:.9)},{passive:!1}),e.addEventListener("dblclick",e=>{if("selectPoly"===this.currentTool&&this._selectionPoints.length>2)return void this._finalizePolySelection();const t=this._canvasPos(e),i=this._findTextLayerAt(t);i&&(this.layerManager.setActive(i.id),this._renderLayersList(),this.setTool("text"),this._editTextLayer(i))})}_canvasPos(e){const t=this.interactionCanvas.getBoundingClientRect(),i=this.interactionCanvas.width/t.width,s=this.interactionCanvas.height/t.height;return{x:(e.clientX-t.left)*i,y:(e.clientY-t.top)*s}}loadImage(e){if(e instanceof File){const t=new FileReader;t.onload=e=>this._loadFromUrl(e.target.result),t.readAsDataURL(e)}else this._loadFromUrl(e)}_loadFromUrl(e){const t=new Image;t.crossOrigin="anonymous",t.onload=()=>this._onImageLoaded(t),t.onerror=()=>{const t=new Image;t.onload=()=>this._onImageLoaded(t),t.src=e},t.src=e}_onImageLoaded(e){this.layerManager=new h,this.layerManager.initFromImage(e),this._activateCanvas()}_initFromPreset(e){this.layerManager=new h,this.layerManager.initFromPreset(e),this._activateCanvas()}_activateCanvas(){const e=this.layerManager;this._setupCanvas(e.docWidth,e.docHeight),this._redraw(),this.emptyState.style.display="none",this.canvasWrap.style.display="inline-block",this.history=[],this.historyIndex=-1,this.pushHistory(),this._renderLayersList(),this._updateLayerOpacityUI(),this._updateStatusDims()}_setupCanvas(e,t){this.mainCanvas.width=e,this.mainCanvas.height=t,this.interactionCanvas.width=e,this.interactionCanvas.height=t;const i=this.canvasArea.getBoundingClientRect(),s=i.width-40,o=i.height-40;this._fitScale=Math.min(1,s/e,o/t),this.zoomLevel=this._fitScale,this._applyZoom(),this.interactionCanvas.parentNode||this.canvasWrap.appendChild(this.interactionCanvas)}_applyZoom(){const e=this.mainCanvas.width,t=this.mainCanvas.height,i=Math.round(e*this.zoomLevel)+"px",s=Math.round(t*this.zoomLevel)+"px";this.mainCanvas.style.width=i,this.mainCanvas.style.height=s,this.interactionCanvas.style.width=i,this.interactionCanvas.style.height=s,this.statusZoom&&(this.statusZoom.textContent=Math.round(100*this.zoomLevel)+"%")}_zoom(e){this.layerManager&&(this.zoomLevel=Math.max(.05,Math.min(32,this.zoomLevel*e)),this._applyZoom())}_zoomFit(){if(!this.layerManager)return;const e=this.canvasArea.getBoundingClientRect(),t=e.width-40,i=e.height-40;this._fitScale=Math.min(1,t/this.mainCanvas.width,i/this.mainCanvas.height),this.zoomLevel=this._fitScale,this._applyZoom()}_redraw(){if(this.layerManager){if(this.layerManager.composite(this.mainCtx),this._applyFilters(),this.layerManager.activeLayer&&this.layerManager.activeLayer.visible){const e=this._getLayerContentBounds(this.layerManager.activeLayer);this._lastLayerBounds=e||null}else this._lastLayerBounds=null;if(!this._selectionAnimFrame&&this.interactionCanvas){const e=this.interactionCanvas.getContext("2d");e.clearRect(0,0,this.interactionCanvas.width,this.interactionCanvas.height),this._drawLayerBounds(e)}}}_applyFilters(){const e=this.filters,t=100!==e.brightness||100!==e.contrast||100!==e.saturation||0!==e.blur||0!==e.grayscale||0!==e.sepia||0!==e.hue;this.mainCanvas.style.filter=t?`brightness(${e.brightness}%) contrast(${e.contrast}%) saturate(${e.saturation}%) blur(${e.blur}px) grayscale(${e.grayscale}%) sepia(${e.sepia}%) hue-rotate(${e.hue}deg)`:""}_getLayerContentBounds(e){if(!e||"group"===e.type)return null;const t=e.width,i=e.height;if(!t||!i)return null;const s=e.ctx.getImageData(0,0,t,i).data;let o=t,a=i,r=-1,n=-1;for(let e=0;e<i;e++)for(let i=0;i<t;i++)s[4*(e*t+i)+3]>0&&(i<o&&(o=i),i>r&&(r=i),e<a&&(a=e),e>n&&(n=e));return r<0?null:{x:o,y:a,width:r-o+1,height:n-a+1}}_drawLayerBounds(e){if(!this.layerManager)return;const t=this.layerManager.activeLayer;if(!t||!t.visible)return;const i=this._getLayerContentBounds(t);if(!i)return;this._lastLayerBounds=i;const s=i.x,o=i.y,a=i.width,r=i.height;e.save(),e.strokeStyle="rgba(0,150,255,0.7)",e.lineWidth=1,e.setLineDash([4,4]),e.strokeRect(s+.5,o+.5,a-1,r-1),e.setLineDash([]);const n=this._getResizeHandles(i);e.fillStyle="#ffffff",e.strokeStyle="rgba(0,150,255,1)",e.lineWidth=1.5,n.forEach(t=>{e.fillRect(t.x-5,t.y-5,10,10),e.strokeRect(t.x-5,t.y-5,10,10)}),e.restore()}_getResizeHandles(e){const t=e.x+e.width/2,i=e.y+e.height/2;return[{id:"tl",x:e.x,y:e.y},{id:"tc",x:t,y:e.y},{id:"tr",x:e.x+e.width,y:e.y},{id:"ml",x:e.x,y:i},{id:"mc",x:t,y:i},{id:"mr",x:e.x+e.width,y:i},{id:"bl",x:e.x,y:e.y+e.height},{id:"bc",x:t,y:e.y+e.height},{id:"br",x:e.x+e.width,y:e.y+e.height}]}_hitTestHandle(e){if(!this._lastLayerBounds)return null;const t=this._getResizeHandles(this._lastLayerBounds);for(const i of t)if(Math.abs(e.x-i.x)<=7&&Math.abs(e.y-i.y)<=7)return i.id;return null}_startVisualResize(e,t,i){const s=this.layerManager.activeLayer;if(!s)return;const o={...this._lastLayerBounds},a=this.interactionCanvas,r=a.getContext("2d"),n=document.createElement("canvas");n.width=o.width,n.height=o.height,n.getContext("2d").drawImage(s.canvas,o.x,o.y,o.width,o.height,0,0,o.width,o.height);const l={...o};let c={...o};a.style.cursor={tl:"nw-resize",tc:"n-resize",tr:"ne-resize",ml:"w-resize",mc:"move",mr:"e-resize",bl:"sw-resize",bc:"s-resize",br:"se-resize"}[e]||"default";const h=()=>{r.clearRect(0,0,a.width,a.height),this._drawLayerBoundsCustom(r,c),r.save(),r.globalAlpha=.6,r.drawImage(n,0,0,n.width,n.height,c.x,c.y,c.width,c.height),r.restore()},d=i=>{const s=this._canvasPos(i),o=s.x-t.x,a=s.y-t.y,r=i.shiftKey,n=l.width/l.height;let d=l.x,p=l.y,u=l.width,g=l.height;"mc"===e?(d=l.x+o,p=l.y+a):"br"===e?(u=Math.max(4,l.width+o),g=Math.max(4,l.height+a),r&&(g=u/n)):"bl"===e?(u=Math.max(4,l.width-o),g=Math.max(4,l.height+a),r&&(g=u/n),d=l.x+l.width-u):"tr"===e?(u=Math.max(4,l.width+o),g=Math.max(4,l.height-a),r&&(g=u/n),p=l.y+l.height-g):"tl"===e?(u=Math.max(4,l.width-o),g=Math.max(4,l.height-a),r&&(g=u/n),d=l.x+l.width-u,p=l.y+l.height-g):"mr"===e?(u=Math.max(4,l.width+o),r&&(g=u/n,p=l.y+(l.height-g)/2)):"ml"===e?(u=Math.max(4,l.width-o),r&&(g=u/n,p=l.y+(l.height-g)/2),d=l.x+l.width-u):"bc"===e?(g=Math.max(4,l.height+a),r&&(u=g*n,d=l.x+(l.width-u)/2)):"tc"===e&&(g=Math.max(4,l.height-a),r&&(u=g*n,d=l.x+(l.width-u)/2),p=l.y+l.height-g),c={x:Math.round(d),y:Math.round(p),width:Math.round(u),height:Math.round(g)},h()},p=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",p),a.style.cursor="",c.width===l.width&&c.height===l.height&&c.x===l.x&&c.y===l.y||(s.ctx.clearRect(0,0,s.width,s.height),s.ctx.drawImage(n,0,0,n.width,n.height,c.x,c.y,c.width,c.height),"text"===s.type&&s.textData&&(s.textData.x=c.x,s.textData.y=c.y),this.pushHistory()),this._redraw(),this._renderLayersList()};document.addEventListener("mousemove",d),document.addEventListener("mouseup",p),h()}_drawLayerBoundsCustom(e,t){e.save(),e.strokeStyle="rgba(0,150,255,0.7)",e.lineWidth=1,e.setLineDash([4,4]),e.strokeRect(t.x+.5,t.y+.5,t.width-1,t.height-1),e.setLineDash([]);const i=this._getResizeHandles(t);e.fillStyle="#ffffff",e.strokeStyle="rgba(0,150,255,1)",e.lineWidth=1.5,i.forEach(t=>{e.fillRect(t.x-5,t.y-5,10,10),e.strokeRect(t.x-5,t.y-5,10,10)}),e.restore()}setTool(e){this.currentTool;this.currentTool=e,i(".jsie-tool-btn[data-tool]:not([data-group])",this.root).forEach(t=>{t.classList.toggle("active",t.dataset.tool===e)}),i(".jsie-tool-group .jsie-tool-btn[data-group]",this.root).forEach(t=>{const i=t.dataset.group,s=this._getGroupTools(i);s&&s.includes(e)?(t.dataset.tool=e,t.innerHTML=(n[e]||"")+'<span class="jsie-group-arrow"></span>',t.title=r("tool."+e),t.classList.add("active"),this._toolGroupSelection[i]=e):t.classList.remove("active")}),this._renderToolOptions(),"crop"===e&&this.layerManager?this._showCropOverlay():this._hideCropOverlay();["selectRect","selectEllipse","selectPoly","selectFree","selectWand"].includes(e)?this.selection&&this._selectionPath&&this._startMarchingAnts():(this._selectionPoints=[],this.selection&&this._selectionPath&&(this._stopMarchingAnts(),this._drawMarchingAnts()));this.interactionCanvas.style.cursor=e?{move:"move",pan:"grab",eyedropper:"crosshair",fill:"crosshair",gradient:"crosshair",pencil:"crosshair",eraser:"crosshair",text:"text",crop:"default",selectRect:"crosshair",selectEllipse:"crosshair",selectPoly:"crosshair",selectFree:"crosshair",selectWand:"crosshair"}[e]||"crosshair":"default",this._updateStatusTool()}_getGroupTools(e){const t=[...this.config.tools.drawing||[],...this.config.tools.transform||[]];for(const i of t)if("object"==typeof i&&i.group===e)return i.tools;return null}_toggleGroupSubmenu(e,t){const s=t.querySelector(".jsie-group-submenu");if(s)return void s.remove();i(".jsie-group-submenu",this.root).forEach(e=>e.remove());const o=this._getGroupTools(e);if(!o)return;const a=t.classList.contains("jsie-action-group"),l=document.createElement("div");l.className="jsie-group-submenu",l.innerHTML=o.map(e=>{if(a)return`<button class="jsie-tool-btn" data-subaction="${e}" title="${r("tool."+e)}">${n[e]||""}</button>`;return`<button class="jsie-tool-btn${this.currentTool===e?" active":""}" data-subtool="${e}" title="${r("tool."+e)}">${n[e]||""}</button>`}).join(""),t.appendChild(l),l.addEventListener("click",t=>{if(a){const e=t.target.closest("[data-subaction]");if(!e)return;const i=e.dataset.subaction;return"rotateLeft"===i?this.rotate(-90):"rotateRight"===i?this.rotate(90):"flipH"===i?this.flip("horizontal"):"flipV"===i&&this.flip("vertical"),void l.remove()}const i=t.target.closest("[data-subtool]");if(!i)return;const s=i.dataset.subtool;this._toolGroupSelection[e]=s,this.setTool(s),l.remove()})}_renderToolOptions(){if(!this.toolOptions)return;this.toolOptions.innerHTML="";const e=this.currentTool;if(!e)return;let t="";if(["pencil","rect","circle","line","arrow","eraser"].includes(e))t+=`<label>${r("opt.color")}</label>${this._colorInputHtml("jsie-opt-color",this.drawColor)}`,t+=`<label>${r("opt.size")}</label><input type="range" id="jsie-opt-size" min="1" max="50" value="${this.strokeSize}">`,["rect","circle"].includes(e)&&(t+=`<div class="jsie-opt-check"><input type="checkbox" id="jsie-opt-fill" ${this.fillEnabled?"checked":""}><label for="jsie-opt-fill">${r("opt.fill")}</label></div>`,t+=this._colorInputHtml("jsie-opt-fill-color",this.fillColor));else if("text"===e){const e=["Arial","Helvetica","Verdana","Tahoma","Trebuchet MS","Georgia","Times New Roman","Courier New","Lucida Console","Impact","Comic Sans MS","Palatino","Garamond","Bookman"],i=[...new Set([...this._loadedGoogleFonts,...e])].map(e=>`<option value="${e}"${e===this.fontFamily?" selected":""}>${e}</option>`).join("");t+='<div class="jsie-text-opts">',t+=`<div class="jsie-text-row"><label>${r("opt.color")}</label>${this._colorInputHtml("jsie-opt-color",this.drawColor)}</div>`,t+=`<div class="jsie-text-row"><label>${r("opt.font")}</label><select id="jsie-opt-font">${i}</select><button type="button" id="jsie-gf-btn" class="jsie-gf-trigger" title="Google Fonts">G</button></div>`,t+=`<div class="jsie-text-row"><label>${r("opt.fontWeight")}</label><select id="jsie-opt-weight"><option value="300"${"300"===this.fontWeight?" selected":""}>Light</option><option value="normal"${"normal"===this.fontWeight?" selected":""}>Regular</option><option value="500"${"500"===this.fontWeight?" selected":""}>Medium</option><option value="bold"${"bold"===this.fontWeight?" selected":""}>Bold</option><option value="900"${"900"===this.fontWeight?" selected":""}>Black</option></select></div>`,t+=`<div class="jsie-text-row"><label>${r("opt.fontStyle")}</label><select id="jsie-opt-style"><option value="normal"${"normal"===this.fontStyle?" selected":""}>Normal</option><option value="italic"${"italic"===this.fontStyle?" selected":""}>Italic</option></select></div>`,t+=`<div class="jsie-text-row"><label>${r("opt.fontSize")}</label><input type="number" id="jsie-opt-fontsize" value="${this.fontSize}" min="8" max="200" style="width:56px"></div>`,t+=`<div class="jsie-text-row"><label>${r("opt.letterSpacing")}</label><input type="number" id="jsie-opt-spacing" value="${this.letterSpacing}" min="-5" max="20" step="0.5" style="width:56px"></div>`,t+=`<div class="jsie-text-row"><label>${r("opt.lineHeight")}</label><input type="number" id="jsie-opt-lineheight" value="${this.lineHeight}" min="0.5" max="3" step="0.1" style="width:56px"></div>`,t+=`<div class="jsie-text-row"><label>${r("opt.textDecoration")}</label><select id="jsie-opt-decoration"><option value="none"${"none"===this.textDecoration?" selected":""}>None</option><option value="underline"${"underline"===this.textDecoration?" selected":""}>Underline</option><option value="line-through"${"line-through"===this.textDecoration?" selected":""}>Strikethrough</option></select></div>`;const s='<svg width="14" height="14" viewBox="0 0 14 14"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" stroke-width="1.5"/><line x1="1" y1="7" x2="9" y2="7" stroke="currentColor" stroke-width="1.5"/><line x1="1" y1="11" x2="11" y2="11" stroke="currentColor" stroke-width="1.5"/></svg>',o='<svg width="14" height="14" viewBox="0 0 14 14"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" stroke-width="1.5"/><line x1="3" y1="7" x2="11" y2="7" stroke="currentColor" stroke-width="1.5"/><line x1="2" y1="11" x2="12" y2="11" stroke="currentColor" stroke-width="1.5"/></svg>',a='<svg width="14" height="14" viewBox="0 0 14 14"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" stroke-width="1.5"/><line x1="5" y1="7" x2="13" y2="7" stroke="currentColor" stroke-width="1.5"/><line x1="3" y1="11" x2="13" y2="11" stroke="currentColor" stroke-width="1.5"/></svg>';t+=`<div class="jsie-text-row"><label>${r("opt.align")}</label><span class="jsie-align-btns"><button type="button" class="jsie-align-btn${"left"===this.textAlign?" active":""}" data-align="left" title="Left">${s}</button><button type="button" class="jsie-align-btn${"center"===this.textAlign?" active":""}" data-align="center" title="Center">${o}</button><button type="button" class="jsie-align-btn${"right"===this.textAlign?" active":""}" data-align="right" title="Right">${a}</button></span></div>`,t+="</div>"}else"fill"===e?(t+=`<label>${r("opt.color")}</label>${this._colorInputHtml("jsie-opt-color",this.drawColor)}`,t+=`<label>${r("opt.tolerance")}</label><input type="range" id="jsie-opt-tolerance" min="0" max="100" value="${this.fillTolerance}">`):"gradient"===e?(t+=`<label>${r("opt.color1")}</label>${this._colorInputHtml("jsie-opt-grad1",this.gradientColor1)}`,t+=`<label>${r("opt.color2")}</label>${this._colorInputHtml("jsie-opt-grad2",this.gradientColor2)}`):"eyedropper"===e?t+=`<label>${r("opt.color")}</label>${this._colorInputHtml("jsie-opt-color",this.drawColor)}`:["selectRect","selectEllipse","selectPoly","selectFree","selectWand"].includes(e)&&("selectWand"===e&&(t+=`<label>${r("opt.tolerance")}</label><input type="range" id="jsie-opt-wand-tolerance" min="0" max="100" value="${this.wandTolerance}"><span id="jsie-wand-tol-val" style="min-width:24px;text-align:center">${this.wandTolerance}</span>`,t+='<span style="width:1px;height:16px;background:var(--jsie-border);margin:0 4px;display:inline-block"></span>'),t+=`<button class="jsie-btn-text secondary" id="jsie-sel-all">${r("sel.all")}</button>`,t+=`<button class="jsie-btn-text secondary" id="jsie-sel-deselect">${r("sel.deselect")}</button>`,t+=`<button class="jsie-btn-text secondary" id="jsie-sel-invert">${r("sel.invert")}</button>`,t+='<span style="width:1px;height:16px;background:var(--jsie-border);margin:0 4px;display:inline-block"></span>',t+=`<button class="jsie-btn-text secondary" id="jsie-sel-crop">${r("sel.cropToSel")}</button>`,t+=`<button class="jsie-btn-text secondary" id="jsie-sel-delete">${r("sel.delete")}</button>`);this.toolOptions.innerHTML=t,this._bindToolOptionEvents()}_bindToolOptionEvents(){const e=t("#jsie-opt-color",this.root),o=t("#jsie-opt-size",this.root),a=t("#jsie-opt-fill",this.root),r=t("#jsie-opt-fill-color",this.root),n=t("#jsie-opt-font",this.root),l=t("#jsie-opt-fontsize",this.root),c=t("#jsie-opt-tolerance",this.root),h=t("#jsie-opt-grad1",this.root),d=t("#jsie-opt-grad2",this.root),p=()=>this._syncTextLayerProps();e&&s(e,"input",()=>{this.drawColor=e.value,p()}),o&&s(o,"input",()=>{this.strokeSize=parseInt(o.value)}),a&&s(a,"change",()=>{this.fillEnabled=a.checked}),r&&s(r,"input",()=>{this.fillColor=r.value}),n&&(n.value=this.fontFamily,s(n,"change",()=>{this.fontFamily=n.value,p()}));const u=t("#jsie-gf-btn",this.root);u&&s(u,"click",()=>this._showGoogleFontsDialog()),l&&s(l,"input",()=>{this.fontSize=parseInt(l.value),p()});const g=t("#jsie-opt-weight",this.root),y=t("#jsie-opt-style",this.root),f=t("#jsie-opt-spacing",this.root),v=t("#jsie-opt-lineheight",this.root),m=t("#jsie-opt-decoration",this.root);g&&s(g,"change",()=>{this.fontWeight=g.value,p()}),y&&s(y,"change",()=>{this.fontStyle=y.value,p()}),f&&s(f,"input",()=>{this.letterSpacing=parseFloat(f.value),p()}),v&&s(v,"input",()=>{this.lineHeight=parseFloat(v.value),p()}),m&&s(m,"change",()=>{this.textDecoration=m.value,p()});const x=i(".jsie-align-btn",this.root);x.forEach(e=>{s(e,"click",()=>{this.textAlign=e.dataset.align,x.forEach(e=>e.classList.remove("active")),e.classList.add("active"),p()})}),c&&s(c,"input",()=>{this.fillTolerance=parseInt(c.value)}),h&&s(h,"input",()=>{this.gradientColor1=h.value}),d&&s(d,"input",()=>{this.gradientColor2=d.value});const b=t("#jsie-opt-wand-tolerance",this.root),w=t("#jsie-wand-tol-val",this.root);b&&s(b,"input",()=>{this.wandTolerance=parseInt(b.value),w&&(w.textContent=b.value)});const j=t("#jsie-sel-all",this.root),_=t("#jsie-sel-deselect",this.root),L=t("#jsie-sel-invert",this.root),M=t("#jsie-sel-crop",this.root),S=t("#jsie-sel-delete",this.root);j&&s(j,"click",()=>this._selectAll()),_&&s(_,"click",()=>this._clearSelection()),L&&s(L,"click",()=>this._invertSelection()),M&&s(M,"click",()=>this._cropToSelection()),S&&s(S,"click",()=>this._deleteSelection()),this._bindColorCombos()}_drawShape(e,t,i,s){if(s.strokeStyle=this.drawColor,s.lineWidth=this.strokeSize,s.lineCap="round",s.lineJoin="round","rect"===e){const e=Math.min(t.x,i.x),o=Math.min(t.y,i.y),a=Math.abs(i.x-t.x),r=Math.abs(i.y-t.y);this.fillEnabled&&(s.fillStyle=this.fillColor,s.fillRect(e,o,a,r)),s.strokeRect(e,o,a,r)}else if("circle"===e){const e=(t.x+i.x)/2,o=(t.y+i.y)/2,a=Math.abs(i.x-t.x)/2,r=Math.abs(i.y-t.y)/2;s.beginPath(),s.ellipse(e,o,Math.max(1,a),Math.max(1,r),0,0,2*Math.PI),this.fillEnabled&&(s.fillStyle=this.fillColor,s.fill()),s.stroke()}else if("line"===e)s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(i.x,i.y),s.stroke();else if("arrow"===e){s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(i.x,i.y),s.stroke();const e=Math.atan2(i.y-t.y,i.x-t.x),o=Math.max(4*this.strokeSize,15);s.beginPath(),s.moveTo(i.x,i.y),s.lineTo(i.x-o*Math.cos(e-Math.PI/6),i.y-o*Math.sin(e-Math.PI/6)),s.moveTo(i.x,i.y),s.lineTo(i.x-o*Math.cos(e+Math.PI/6),i.y-o*Math.sin(e+Math.PI/6)),s.stroke()}}_buildSelectionPath(){if(!this.selection)return void(this._selectionPath=null);const e=this.selection,t=new Path2D;if("rect"===e.type)t.rect(e.x,e.y,e.width,e.height);else if("ellipse"===e.type)t.ellipse(e.cx,e.cy,Math.max(1,e.rx),Math.max(1,e.ry),0,0,2*Math.PI);else if("poly"===e.type||"free"===e.type){if(e.points.length>2){t.moveTo(e.points[0].x,e.points[0].y);for(let i=1;i<e.points.length;i++)t.lineTo(e.points[i].x,e.points[i].y);t.closePath()}}else if("wand"===e.type&&e.mask){const i=e.width,s=e.height,o=e.mask;for(let e=0;e<s;e++){let s=0;for(;s<i;)if(o[e*i+s]){const a=s;for(;s<i&&o[e*i+s];)s++;t.rect(a,e,s-a,1)}else s++}}this._selectionPath=t}_clearSelection(){this.selection=null,this._selectionPath=null,this._selectionContourPath=null,this._selectionPoints=[],this._selectionPreview=null,this._selectionStart=null,this._stopMarchingAnts()}_getSelectionBounds(){if(!this.selection)return null;const e=this.selection;if("rect"===e.type)return{x:Math.round(Math.min(e.x,e.x+e.width)),y:Math.round(Math.min(e.y,e.y+e.height)),width:Math.round(Math.abs(e.width)),height:Math.round(Math.abs(e.height))};if("ellipse"===e.type)return{x:Math.round(e.cx-e.rx),y:Math.round(e.cy-e.ry),width:Math.round(2*e.rx),height:Math.round(2*e.ry)};if("poly"===e.type||"free"===e.type){let t=1/0,i=1/0,s=-1/0,o=-1/0;for(const a of e.points)t=Math.min(t,a.x),i=Math.min(i,a.y),s=Math.max(s,a.x),o=Math.max(o,a.y);return{x:Math.round(t),y:Math.round(i),width:Math.round(s-t),height:Math.round(o-i)}}if("wand"===e.type&&e.mask){let t=e.width,i=e.height,s=0,o=0;for(let a=0;a<e.height;a++)for(let r=0;r<e.width;r++)e.mask[a*e.width+r]&&(r<t&&(t=r),r>s&&(s=r),a<i&&(i=a),a>o&&(o=a));return s>=t&&o>=i?{x:t,y:i,width:s-t+1,height:o-i+1}:null}return"inverted"===e.type?{x:0,y:0,width:e.docWidth,height:e.docHeight}:null}_selectAll(){this.layerManager&&(this.selection={type:"rect",x:0,y:0,width:this.layerManager.docWidth,height:this.layerManager.docHeight},this._buildSelectionPath(),this._startMarchingAnts())}_invertSelection(){if(!this.selection||!this._selectionPath||!this.layerManager)return;const e=this.layerManager,t=new Path2D;t.rect(0,0,e.docWidth,e.docHeight),t.addPath(this._selectionPath),this._selectionPath=t,this.selection={type:"inverted",original:this.selection,docWidth:e.docWidth,docHeight:e.docHeight},this._startMarchingAnts()}_startMarchingAnts(){this._stopMarchingAnts();const e=()=>{this._selectionAntsOffset=(this._selectionAntsOffset+1)%16,this._drawMarchingAnts(),this._selectionAnimFrame=requestAnimationFrame(e)};this._selectionAnimFrame=requestAnimationFrame(e)}_stopMarchingAnts(){if(this._selectionAnimFrame&&(cancelAnimationFrame(this._selectionAnimFrame),this._selectionAnimFrame=null),this.interactionCanvas){const e=this.interactionCanvas.getContext("2d");e.clearRect(0,0,this.interactionCanvas.width,this.interactionCanvas.height),this._drawLayerBounds(e)}}_drawMarchingAnts(){if(!this._selectionPath||!this.interactionCanvas)return;const e=this.interactionCanvas,t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),this._drawLayerBounds(t),t.save(),this._selectionContourPath?(t.lineWidth=2,t.strokeStyle="#000000",t.stroke(this._selectionContourPath),t.lineWidth=1,t.strokeStyle="#ffffff",t.stroke(this._selectionContourPath)):(t.strokeStyle="#ffffff",t.lineWidth=1,t.setLineDash([4,4]),t.lineDashOffset=-this._selectionAntsOffset,t.stroke(this._selectionPath),t.strokeStyle="#000000",t.lineDashOffset=-(this._selectionAntsOffset+4),t.stroke(this._selectionPath)),t.restore()}_drawSelectionPreview(e){if(!this.interactionCanvas)return;const t=this.interactionCanvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.save(),i.strokeStyle="#ffffff",i.lineWidth=1,i.setLineDash([4,4]),i.lineDashOffset=0,i.stroke(e),i.strokeStyle="#000000",i.lineDashOffset=-4,i.stroke(e),i.restore()}_finalizePolySelection(){if(this._selectionPoints.length<3)return this._selectionPoints=[],void this._stopMarchingAnts();this.selection={type:"poly",points:[...this._selectionPoints]},this._selectionPoints=[],this._buildSelectionPath(),this._startMarchingAnts()}_drawPolyPreview(e){if(!this.interactionCanvas||0===this._selectionPoints.length)return;const t=this.interactionCanvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.save(),i.setLineDash([4,4]),i.lineWidth=1,i.strokeStyle="#ffffff",i.lineDashOffset=0,i.beginPath(),i.moveTo(this._selectionPoints[0].x,this._selectionPoints[0].y);for(let e=1;e<this._selectionPoints.length;e++)i.lineTo(this._selectionPoints[e].x,this._selectionPoints[e].y);e&&i.lineTo(e.x,e.y),i.stroke(),i.strokeStyle="#000000",i.lineDashOffset=-4,i.beginPath(),i.moveTo(this._selectionPoints[0].x,this._selectionPoints[0].y);for(let e=1;e<this._selectionPoints.length;e++)i.lineTo(this._selectionPoints[e].x,this._selectionPoints[e].y);if(e&&i.lineTo(e.x,e.y),i.stroke(),this._selectionPoints.length>2&&e){const t=this._selectionPoints[0];Math.hypot(e.x-t.x,e.y-t.y)<8&&(i.setLineDash([]),i.strokeStyle="#ff6600",i.lineWidth=2,i.beginPath(),i.arc(t.x,t.y,6,0,2*Math.PI),i.stroke())}i.restore()}_copySelection(){if(!this.selection||!this._selectionPath||!this.layerManager)return;const e=this.layerManager,t=document.createElement("canvas");t.width=e.docWidth,t.height=e.docHeight;const i=t.getContext("2d");i.save(),i.clip(this._selectionPath,"evenodd"),e.composite(i),i.restore(),this._clipboard={canvas:t,bounds:this._getSelectionBounds()}}_cutSelection(){this._copySelection(),this._deleteSelection()}_deleteSelection(){if(!this.selection||!this._selectionPath||!this.layerManager)return;const e=this.layerManager.activeLayer;e&&!e.locked&&(e.ctx.save(),e.ctx.clip(this._selectionPath,"evenodd"),e.ctx.clearRect(0,0,e.width,e.height),e.ctx.restore(),this.pushHistory(),this._redraw(),this._scheduleThumbnailUpdate())}_pasteSelection(){if(!this._clipboard||!this.layerManager)return;this.layerManager.addLayer("Pasted").ctx.drawImage(this._clipboard.canvas,0,0),this.pushHistory(),this._redraw(),this._renderLayersList(),this._updateLayerOpacityUI(),this.setTool("move")}_cropToSelection(){if(!this.selection||!this.layerManager)return;const e=this._getSelectionBounds();if(!e||e.width<1||e.height<1)return;const{x:i,y:s,width:o,height:a}=e,r=this.layerManager;for(const e of r.layers){if("group"===e.type)continue;const t=document.createElement("canvas");t.width=o,t.height=a;t.getContext("2d").drawImage(e.canvas,i,s,o,a,0,0,o,a),e.canvas.width=o,e.canvas.height=a,e.width=o,e.height=a,e.ctx.drawImage(t,0,0)}r.docWidth=o,r.docHeight=a,this._clearSelection(),this.mainCanvas.width=o,this.mainCanvas.height=a,this.interactionCanvas.width=o,this.interactionCanvas.height=a,this._redraw(),this.pushHistory(),this._renderLayersList();const n=t("#jsie-status-dims",this.root);n&&(n.textContent=`${o} × ${a}`)}_pickColor(e){const i=this.mainCtx.getImageData(Math.round(e.x),Math.round(e.y),1,1).data,s="#"+((1<<24)+(i[0]<<16)+(i[1]<<8)+i[2]).toString(16).slice(1);this.drawColor=s;const o=t("#jsie-opt-color",this.root);o&&(o.value=s);const a=t('.jsie-hex-input[data-for="jsie-opt-color"]',this.root);a&&(a.value=s)}_floodFill(e,t,i,s,o){const a=e.width,r=e.height;if(t<0||t>=a||i<0||i>=r)return;const n=e.ctx.getImageData(0,0,a,r),l=n.data,c=4*(i*a+t),h=l[c],d=l[c+1],p=l[c+2],u=l[c+3],g=this._hexToRgb(s);if(g.r===h&&g.g===d&&g.b===p&&255===u)return;const y=o*o,f=new Uint8Array(a*r),v=e=>{const t=l[e]-h,i=l[e+1]-d,s=l[e+2]-p,o=l[e+3]-u;return t*t+i*i+s*s+o*o<=4*y},m=[[t,i]];for(;m.length>0;){let[e,t]=m.pop();if(f[t*a+e])continue;for(;e>=0&&v(4*(t*a+e));)e--;e++;let i=!1,s=!1;for(;e<a&&v(4*(t*a+e));){const o=4*(t*a+e);if(l[o]=g.r,l[o+1]=g.g,l[o+2]=g.b,l[o+3]=255,f[t*a+e]=1,t>0){const s=v(4*((t-1)*a+e));i||!s||f[(t-1)*a+e]?s||(i=!1):(m.push([e,t-1]),i=!0)}if(t<r-1){const i=v(4*((t+1)*a+e));s||!i||f[(t+1)*a+e]?i||(s=!1):(m.push([e,t+1]),s=!0)}e++}}e.ctx.putImageData(n,0,0)}_magicWandSelect(e,t){const i=this.layerManager;if(!i)return;const s=i.docWidth,o=i.docHeight;if(e=Math.round(e),t=Math.round(t),e<0||e>=s||t<0||t>=o)return;const a=i.flatten().getContext("2d").getImageData(0,0,s,o).data,r=4*(t*s+e),n=a[r],l=a[r+1],c=a[r+2],h=a[r+3],d=Math.round(2.55*this.wandTolerance),p=new Uint8Array(s*o),u=new Uint8Array(s*o),g=e=>{const t=Math.abs(a[e]-n),i=Math.abs(a[e+1]-l),s=Math.abs(a[e+2]-c),o=Math.abs(a[e+3]-h);return Math.max(t,i,s,o)<=d},y=[[e,t]];for(;y.length>0;){let[e,t]=y.pop();if(u[t*s+e])continue;for(;e>=0&&g(4*(t*s+e));)e--;e++;let i=!1,a=!1;for(;e<s&&g(4*(t*s+e));){const r=t*s+e;if(p[r]=1,u[r]=1,t>0){const o=g(4*((t-1)*s+e));i||!o||u[(t-1)*s+e]?o||(i=!1):(y.push([e,t-1]),i=!0)}if(t<o-1){const i=g(4*((t+1)*s+e));a||!i||u[(t+1)*s+e]?i||(a=!1):(y.push([e,t+1]),a=!0)}e++}}this.selection={type:"wand",mask:p,width:s,height:o},this._buildSelectionPath(),this._selectionContourPath=this._buildWandContour(p,s,o),this._startMarchingAnts()}_buildWandContour(e,t,i){const s=new Path2D;for(let o=0;o<i;o++){let a=-1;for(let i=0;i<=t;i++){const r=i<t&&e[o*t+i],n=o>0&&i<t&&e[(o-1)*t+i];r&&!n?a<0&&(a=i):a>=0&&(s.moveTo(a,o),s.lineTo(i,o),a=-1)}a=-1;for(let r=0;r<=t;r++){const n=r<t&&e[o*t+r],l=o<i-1&&r<t&&e[(o+1)*t+r];n&&!l?a<0&&(a=r):a>=0&&(s.moveTo(a,o+1),s.lineTo(r,o+1),a=-1)}}for(let o=0;o<t;o++){let a=-1;for(let r=0;r<=i;r++){const n=r<i&&e[r*t+o],l=o>0&&r<i&&e[r*t+o-1];n&&!l?a<0&&(a=r):a>=0&&(s.moveTo(o,a),s.lineTo(o,r),a=-1)}a=-1;for(let r=0;r<=i;r++){const n=r<i&&e[r*t+o],l=o<t-1&&r<i&&e[r*t+o+1];n&&!l?a<0&&(a=r):a>=0&&(s.moveTo(o+1,a),s.lineTo(o+1,r),a=-1)}}return s}_hexToRgb(e){const t=parseInt(e.replace("#",""),16);return{r:t>>16&255,g:t>>8&255,b:255&t}}_drawGradientPreview(e,t,i){const s=this.interactionCanvas.getContext("2d");s.clearRect(0,0,this.interactionCanvas.width,this.interactionCanvas.height),s.setLineDash([5,5]),s.strokeStyle="#fff",s.lineWidth=1,s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(i.x,i.y),s.stroke(),s.setLineDash([])}_applyGradient(e,t,i){const s=e.createLinearGradient(t.x,t.y,i.x,i.y);s.addColorStop(0,this.gradientColor1),s.addColorStop(1,this.gradientColor2),e.fillStyle=s,e.fillRect(0,0,e.canvas.width,e.canvas.height);this.interactionCanvas.getContext("2d").clearRect(0,0,this.interactionCanvas.width,this.interactionCanvas.height)}_loadTextLayerProps(e){if(!e||"text"!==e.type||!e.textData)return;const t=e.textData;this.drawColor=t.color||this.drawColor,this.fontFamily=t.fontFamily||this.fontFamily,this.fontSize=t.fontSize||this.fontSize,this.fontWeight=t.fontWeight||"normal",this.fontStyle=t.fontStyle||"normal",this.letterSpacing=t.letterSpacing||0,this.lineHeight=t.lineHeight||1.2,this.textAlign=t.align||"left",this.textDecoration=t.textDecoration||"none",this._renderToolOptions()}_syncTextLayerProps(){if(!this.layerManager)return;const e=this.layerManager.activeLayer;if(!e||"text"!==e.type||!e.textData)return;const t=e.textData;t.color=this.drawColor,t.fontSize=this.fontSize,t.fontFamily=this.fontFamily,t.fontWeight=this.fontWeight,t.fontStyle=this.fontStyle,t.letterSpacing=this.letterSpacing,t.lineHeight=this.lineHeight,t.align=this.textAlign,t.textDecoration=this.textDecoration,e._renderText(),this._redraw()}_findTextLayerAt(e){if(!this.layerManager)return null;const t=this.layerManager.layers;for(let i=t.length-1;i>=0;i--){const s=t[i];if("text"!==s.type||!s.visible||!s.textData)continue;const o=this._getLayerContentBounds(s);if(o&&(e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height))return s}return null}_placeText(e){this._finishActiveTextEdit();const i=t(".jsie-text-input-overlay",this.canvasWrap);i&&i.remove();const s=document.createElement("div");s.className="jsie-text-input-overlay";const o=this.interactionCanvas.getBoundingClientRect(),a=o.width/this.interactionCanvas.width,r=o.height/this.interactionCanvas.height;s.style.left=e.x*a+"px",s.style.top=e.y*r+"px";const n=document.createElement("textarea");n.style.fontSize=this.fontSize*r+"px",n.style.fontFamily=this.fontFamily,n.style.color=this.drawColor,n.style.fontWeight=this.fontWeight,n.style.fontStyle=this.fontStyle,n.style.letterSpacing=this.letterSpacing+"px",n.style.textDecoration=this.textDecoration,n.style.textAlign=this.textAlign,n.style.lineHeight=this.lineHeight,n.rows=1,n.cols=20,s.appendChild(n),this.canvasWrap.appendChild(s);let l=!1;const c=t=>{if(!l){if(l=!0,this._activeTextEdit=null,document.removeEventListener("mousedown",h,!0),t){const t=n.value;t&&this.layerManager&&this._createTextLayer(t,e)}s.remove()}};this._activeTextEdit=c;const h=e=>{s.contains(e.target)||(e.preventDefault(),e.stopPropagation(),c(!0))};setTimeout(()=>{l||document.addEventListener("mousedown",h,!0)},0),n.focus(),n.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey?"Escape"===e.key&&c(!1):(e.preventDefault(),c(!0))})}_createTextLayer(e,t){const i=this.layerManager,s={text:e,x:t.x,y:t.y,color:this.drawColor,fontSize:this.fontSize,fontFamily:this.fontFamily,align:this.textAlign,lineHeight:this.lineHeight,fontWeight:this.fontWeight,fontStyle:this.fontStyle,letterSpacing:this.letterSpacing,textDecoration:this.textDecoration},o=new c({name:"T: "+e.substring(0,15),width:i.docWidth,height:i.docHeight,type:"text",textData:s}),a=i.activeIndex;i.layers.splice(a+1,0,o),i.activeLayerId=o.id,this.pushHistory(),this._redraw(),this._renderLayersList(),this._updateLayerOpacityUI()}_finishActiveTextEdit(){this._activeTextEdit&&(this._activeTextEdit(!0),this._activeTextEdit=null)}_editTextLayer(e){if("text"!==e.type||!e.textData)return;const i=e.textData;this._finishActiveTextEdit();const s=t(".jsie-text-input-overlay",this.canvasWrap);s&&s.remove(),this._loadTextLayerProps(e);const o=this.interactionCanvas.getBoundingClientRect(),a=o.width/this.interactionCanvas.width,r=o.height/this.interactionCanvas.height,n=document.createElement("div");n.className="jsie-text-input-overlay",n.style.left=i.x*a+"px",n.style.top=i.y*r+"px";const l=document.createElement("textarea");l.style.fontSize=i.fontSize*r+"px",l.style.fontFamily=i.fontFamily,l.style.color=i.color,l.style.fontWeight=i.fontWeight||"normal",l.style.fontStyle=i.fontStyle||"normal",l.style.letterSpacing=(i.letterSpacing||0)+"px",l.style.textDecoration=i.textDecoration||"none",l.style.textAlign=i.align||"left",l.style.lineHeight=i.lineHeight||1.2,l.value=i.text,l.rows=2,l.cols=20,n.appendChild(l),this.canvasWrap.appendChild(n),e.ctx.clearRect(0,0,e.width,e.height),this._redraw();let c=!1;const h=t=>{if(!c){if(c=!0,this._activeTextEdit=null,document.removeEventListener("mousedown",d,!0),n.remove(),t){const t=l.value;t&&(i.text=t,i.color=this.drawColor,i.fontSize=this.fontSize,i.fontFamily=this.fontFamily,i.fontWeight=this.fontWeight,i.fontStyle=this.fontStyle,i.letterSpacing=this.letterSpacing,i.lineHeight=this.lineHeight,i.align=this.textAlign,i.textDecoration=this.textDecoration,e.name="T: "+t.substring(0,15))}e._renderText(),this.pushHistory(),this._redraw(),this._renderLayersList()}};this._activeTextEdit=h;const d=e=>{n.contains(e.target)||(e.preventDefault(),e.stopPropagation(),h(!0))};setTimeout(()=>{c||document.addEventListener("mousedown",d,!0)},0),l.focus(),l.select(),l.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey?"Escape"===e.key&&h(!1):(e.preventDefault(),h(!0))})}_showCropOverlay(){this._hideCropOverlay();const e=this.canvasWrap,t=document.createElement("div");t.className="jsie-crop-overlay";const i=parseFloat(this.mainCanvas.style.width),s=parseFloat(this.mainCanvas.style.height),o=.1,a=i*o,n=s*o,l=.8*i,c=.8*s;t.innerHTML=`\n        <div class="jsie-crop-rect" style="left:${a}px;top:${n}px;width:${l}px;height:${c}px">\n          <div class="jsie-crop-handle tl"></div>\n          <div class="jsie-crop-handle tr"></div>\n          <div class="jsie-crop-handle bl"></div>\n          <div class="jsie-crop-handle br"></div>\n        </div>\n      `,e.appendChild(t);const h=document.createElement("button");h.className="jsie-btn-text",h.style.cssText="position:absolute;bottom:10px;right:10px;z-index:11",h.textContent=r("btn.apply"),h.addEventListener("click",()=>this._applyCrop()),e.appendChild(h),this._cropApplyBtn=h,this._cropOverlay=t,this._setupCropDrag(t)}_hideCropOverlay(){this._cropOverlay&&(this._cropOverlay.remove(),this._cropOverlay=null),this._cropApplyBtn&&(this._cropApplyBtn.remove(),this._cropApplyBtn=null)}_setupCropDrag(e){const t=e.querySelector(".jsie-crop-rect");let i,s,o,a=null;const r=e=>{if(!a)return;const r=e.clientX-i,n=e.clientY-s,l=parseFloat(this.mainCanvas.style.width),c=parseFloat(this.mainCanvas.style.height);if("move"===a){let e=Math.max(0,Math.min(l-o.width,o.left+r)),i=Math.max(0,Math.min(c-o.height,o.top+n));t.style.left=e+"px",t.style.top=i+"px"}else{let{left:e,top:i,width:s,height:h}=o;"br"===a?(s=Math.max(20,s+r),h=Math.max(20,h+n)):"bl"===a?(e+=r,s=Math.max(20,s-r),h=Math.max(20,h+n)):"tr"===a?(i+=n,s=Math.max(20,s+r),h=Math.max(20,h-n)):"tl"===a&&(e+=r,i+=n,s=Math.max(20,s-r),h=Math.max(20,h-n)),t.style.left=Math.max(0,e)+"px",t.style.top=Math.max(0,i)+"px",t.style.width=Math.min(s,l)+"px",t.style.height=Math.min(h,c)+"px"}},n=()=>{a=null,document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};e.addEventListener("mousedown",e=>{e.preventDefault();const l=e.target.closest(".jsie-crop-handle");if(l)a=l.classList.contains("tl")?"tl":l.classList.contains("tr")?"tr":l.classList.contains("bl")?"bl":"br";else{if(e.target!==t&&!t.contains(e.target))return;a="move"}i=e.clientX,s=e.clientY,o={left:parseFloat(t.style.left),top:parseFloat(t.style.top),width:parseFloat(t.style.width),height:parseFloat(t.style.height)},document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)})}_applyCrop(){if(!this._cropOverlay||!this.layerManager)return;const e=this._cropOverlay.querySelector(".jsie-crop-rect"),t=parseFloat(this.mainCanvas.style.width),i=parseFloat(this.mainCanvas.style.height),s=this.layerManager,o=s.docWidth/t,a=s.docHeight/i,r=Math.round(parseFloat(e.style.left)*o),n=Math.round(parseFloat(e.style.top)*a),l=Math.round(parseFloat(e.style.width)*o),c=Math.round(parseFloat(e.style.height)*a);for(const e of s.layers){const t=document.createElement("canvas");t.width=l,t.height=c;t.getContext("2d").drawImage(e.canvas,r,n,l,c,0,0,l,c),e.canvas.width=l,e.canvas.height=c,e.width=l,e.height=c,e.ctx.drawImage(t,0,0)}s.docWidth=l,s.docHeight=c,this.filters={brightness:100,contrast:100,saturation:100,blur:0,grayscale:0,sepia:0,hue:0},this._resetFilterSliders(),this._setupCanvas(l,c),this._redraw(),this._hideCropOverlay(),this.setTool(null),this.pushHistory(),this._renderLayersList(),this._updateStatusDims()}_resetFilterSliders(){i("input[data-filter]",this.root).forEach(e=>{const t=e.dataset.filter;e.value=this.filters[t],e.nextElementSibling.textContent=this.filters[t]})}showResizePanel(){if(!this.layerManager)return;const e=t(".jsie-resize-panel",this.canvasWrap);if(e)return void e.remove();const i=this.layerManager.docWidth,s=this.layerManager.docHeight,o=i/s,a=document.createElement("div");a.className="jsie-resize-panel",a.innerHTML=`\n        <div class="jsie-row"><label>${r("opt.width")}</label><input type="number" id="jsie-rw" value="${i}" min="1"></div>\n        <div class="jsie-row"><label>${r("opt.height")}</label><input type="number" id="jsie-rh" value="${s}" min="1"></div>\n        <div class="jsie-checkbox-row"><input type="checkbox" id="jsie-lock" checked><label for="jsie-lock">${r("opt.lockRatio")}</label></div>\n        <button class="jsie-btn-text">${r("btn.apply")}</button>\n      `,this.canvasWrap.appendChild(a);const n=a.querySelector("#jsie-rw"),l=a.querySelector("#jsie-rh"),c=a.querySelector("#jsie-lock");n.addEventListener("input",()=>{c.checked&&(l.value=Math.round(parseInt(n.value)/o))}),l.addEventListener("input",()=>{c.checked&&(n.value=Math.round(parseInt(l.value)*o))}),a.querySelector(".jsie-btn-text").addEventListener("click",()=>{const e=parseInt(n.value),t=parseInt(l.value);e>0&&t>0&&this._applyResize(e,t),a.remove()})}_applyResize(e,t){if(!this.layerManager)return;const i=this.layerManager;for(const s of i.layers)s.resize(e,t);i.docWidth=e,i.docHeight=t,this.filters={brightness:100,contrast:100,saturation:100,blur:0,grayscale:0,sepia:0,hue:0},this._resetFilterSliders(),this._setupCanvas(e,t),this._redraw(),this.pushHistory(),this._renderLayersList(),this._updateStatusDims()}rotate(e){if(!this.layerManager)return;const t=this.layerManager,i=e*Math.PI/180,s=90===Math.abs(e)||270===Math.abs(e),o=s?t.docHeight:t.docWidth,a=s?t.docWidth:t.docHeight;for(const e of t.layers){const t=document.createElement("canvas");t.width=o,t.height=a;const s=t.getContext("2d");s.translate(o/2,a/2),s.rotate(i),s.drawImage(e.canvas,-e.width/2,-e.height/2),e.canvas.width=o,e.canvas.height=a,e.width=o,e.height=a,e.ctx.drawImage(t,0,0)}t.docWidth=o,t.docHeight=a,this._setupCanvas(o,a),this._redraw(),this.pushHistory(),this._renderLayersList(),this._updateStatusDims()}flip(e){if(!this.layerManager)return;const t=this.layerManager;for(const i of t.layers){const t=document.createElement("canvas");t.width=i.width,t.height=i.height;const s=t.getContext("2d");"horizontal"===e?(s.translate(i.width,0),s.scale(-1,1)):(s.translate(0,i.height),s.scale(1,-1)),s.drawImage(i.canvas,0,0),i.ctx.clearRect(0,0,i.width,i.height),i.ctx.drawImage(t,0,0)}this._redraw(),this.pushHistory(),this._renderLayersList()}pushHistory(){if(!this.layerManager)return;this.history=this.history.slice(0,this.historyIndex+1);const e={layerState:this.layerManager.serialize(),filters:{...this.filters}};this.history.push(e),this.history.length>this.config.maxHistory&&this.history.shift(),this.historyIndex=this.history.length-1}undo(){this.historyIndex<=0||(this.historyIndex--,this._restoreHistory(this.history[this.historyIndex]))}redo(){this.historyIndex>=this.history.length-1||(this.historyIndex++,this._restoreHistory(this.history[this.historyIndex]))}_restoreHistory(e){this.layerManager.restore(e.layerState),this.filters={...e.filters},this._resetFilterSliders(),this._setupCanvas(this.layerManager.docWidth,this.layerManager.docHeight),this._redraw(),this._renderLayersList(),this._updateLayerOpacityUI(),this._updateStatusDims()}_flatten(){if(!this.layerManager)return null;const e=this.layerManager.flatten(),t=this.filters;if(100!==t.brightness||100!==t.contrast||100!==t.saturation||0!==t.blur||0!==t.grayscale||0!==t.sepia||0!==t.hue){const i=document.createElement("canvas");i.width=e.width,i.height=e.height;const s=i.getContext("2d");return s.filter=`brightness(${t.brightness}%) contrast(${t.contrast}%) saturate(${t.saturation}%) blur(${t.blur}px) grayscale(${t.grayscale}%) sepia(${t.sepia}%) hue-rotate(${t.hue}deg)`,s.drawImage(e,0,0),i}return e}getImage(){const e=this._flatten();if(!e)return null;const t="jpeg"===this.config.outputFormat?"image/jpeg":"webp"===this.config.outputFormat?"image/webp":"image/png";return e.toDataURL(t,this.config.outputQuality)}getBlob(){return new Promise(e=>{const t=this._flatten();if(!t)return void e(null);const i="jpeg"===this.config.outputFormat?"image/jpeg":"webp"===this.config.outputFormat?"image/webp":"image/png";t.toBlob(t=>e(t),i,this.config.outputQuality)})}_findLayerById(e){for(const t of this.layerManager.layers){if(t.id===e)return t;if("group"===t.type){const i=t.children.find(t=>t.id===e);if(i)return i}}return null}_renderLayerItem(e,t,i=!1){const s=document.createElement("div");let o="jsie-layer-item";e.id===this.layerManager.activeLayerId&&(o+=" active"),"group"===e.type&&(o+=" group-item"),i&&(o+=" group-child"),s.className=o,s.dataset.layerId=e.id,s.draggable=!0;const a=e.visible?"":" hidden",r=e.visible?n.eye:n.eyeOff;let l;if("text"===e.type)l='<div class="jsie-layer-text-icon">T</div>';else if("group"===e.type){const t=e.collapsed?n.chevronRight:n.chevronDown;l=`<span class="jsie-layer-group-toggle" data-group-toggle="${e.id}">${t}</span>`}else l=`<div class="jsie-layer-thumb"><img src="${e.getThumbnail()}" alt=""></div>`;if(s.innerHTML=`\n        <span class="jsie-layer-vis${a}" data-layer-vis="${e.id}">${r}</span>\n        ${l}\n        <span class="jsie-layer-name">${e.name}</span>\n      `,t.appendChild(s),"group"===e.type&&!e.collapsed){const i=[...e.children].reverse();for(const e of i)this._renderLayerItem(e,t,!0)}}_renderLayersList(){if(!this.layersList||!this.layerManager)return;this.layersList.innerHTML="";const e=[...this.layerManager.layers].reverse();for(const t of e)this._renderLayerItem(t,this.layersList)}_updateLayerOpacityUI(){if(!this.layerManager)return;const e=this.layerManager.activeLayer;if(e){if(this.layerOpacitySlider){const t=Math.round(100*e.opacity);this.layerOpacitySlider.value=t,this.layerOpacityVal.textContent=t+"%"}this.layerBlendSelect&&(this.layerBlendSelect.value=e.blendMode||"normal")}}_scheduleThumbnailUpdate(){clearTimeout(this._thumbTimer),this._thumbTimer=setTimeout(()=>this._renderLayersList(),300)}_updateStatusDims(){this.statusDims&&this.layerManager&&(this.statusDims.textContent=`${this.layerManager.docWidth} × ${this.layerManager.docHeight}`)}_updateStatusCursor(e){this.statusCursor&&(this.statusCursor.textContent=`X: ${Math.round(e.x)}  Y: ${Math.round(e.y)}`)}_updateStatusTool(){this.statusTool&&(this.statusTool.textContent=this.currentTool?r("tool."+this.currentTool):"")}reset(){this.layerManager&&confirm(r("confirm.reset"))&&this.history.length>0&&(this.historyIndex=0,this._restoreHistory(this.history[0]))}_triggerImport(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",e.onchange=()=>{e.files[0]&&this.importAsLayer(e.files[0]),e.remove()},document.body.appendChild(e),e.click()}importAsLayer(e){if(this.layerManager)if(e instanceof File){const t=new FileReader;t.onload=e=>this._importImageAsLayer(e.target.result),t.readAsDataURL(e)}else this._importImageAsLayer(e);else this.loadImage(e)}_importImageAsLayer(e){const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{const e=this.layerManager,i=new c({name:"Imported",width:e.docWidth,height:e.docHeight}),s=Math.max(0,Math.floor((e.docWidth-t.width)/2)),o=Math.max(0,Math.floor((e.docHeight-t.height)/2));i.ctx.drawImage(t,s,o,Math.min(t.width,e.docWidth),Math.min(t.height,e.docHeight));const a=e.activeIndex;e.layers.splice(a+1,0,i),e.activeLayerId=i.id,this._clearSelection(),this.pushHistory(),this._redraw(),this._renderLayersList(),this._updateLayerOpacityUI()},t.src=e}_loadedGoogleFonts=new Set;_googleFontsList(){return["Roboto","Open Sans","Lato","Montserrat","Oswald","Raleway","Poppins","Nunito","Ubuntu","Merriweather","Playfair Display","Rubik","Inter","Noto Sans","Work Sans","Fira Sans","Quicksand","Barlow","Mulish","Inconsolata","Karla","Cabin","Arimo","Dosis","Bitter","Josefin Sans","Anton","Lobster","Pacifico","Dancing Script","Caveat","Permanent Marker","Satisfy","Shadows Into Light","Indie Flower","Amatic SC","Comfortaa","Bebas Neue","Archivo","Manrope","Sora","Space Grotesk","DM Sans","Plus Jakarta Sans","Outfit","Lexend","Jost","Urbanist","Figtree","Geist","Nunito Sans","Titillium Web","PT Sans","Source Sans 3","Hind","Libre Franklin","Exo 2","Rajdhani","Kanit","Prompt","Sarabun","Heebo","Overpass","Yanone Kaffeesatz","Righteous","Alfa Slab One","Bungee","Press Start 2P","Silkscreen","VT323","Special Elite","Orbitron","Cinzel","Cormorant Garamond","EB Garamond","Spectral","Crimson Text","Source Serif 4","Zilla Slab","IBM Plex Sans","IBM Plex Mono","Fira Code","JetBrains Mono","Source Code Pro","Roboto Mono","Space Mono"]}_loadGoogleFont(e){return new Promise((t,i)=>{if(this._loadedGoogleFonts.has(e))return void t();const s=e.replace(/ /g,"+"),o=document.createElement("link");o.rel="stylesheet",o.href=`https://fonts.googleapis.com/css2?family=${s}:wght@300;400;500;700;900&display=swap`,o.onload=()=>{const i=["300","400","500","700","900"].map(t=>document.fonts.load(`${t} 16px "${e}"`));Promise.all(i).then(()=>{this._loadedGoogleFonts.add(e),t()}).catch(()=>{this._loadedGoogleFonts.add(e),t()})},o.onerror=()=>i(new Error(`Failed to load font: ${e}`)),document.head.appendChild(o)})}_showGoogleFontsDialog(){const e=this._googleFontsList(),t=document.createElement("div");t.className="jsie-modal-overlay",t.style.zIndex="10001";const i=document.createElement("div");i.style.cssText="background:var(--jsie-bg);padding:24px;border-radius:8px;width:520px;max-width:90vw;max-height:80vh;color:var(--jsie-text);display:flex;flex-direction:column",i.innerHTML=`\n        <h3 style="margin:0 0 12px;font-size:16px">${r("fonts.title")}</h3>\n        <div style="display:flex;gap:8px;margin-bottom:12px">\n          <input type="text" id="jsie-gf-search" placeholder="${r("fonts.search")}" style="flex:1;height:28px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:4px;padding:0 8px;font-size:12px">\n        </div>\n        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">\n          <input type="text" id="jsie-gf-custom" placeholder="${r("fonts.custom")}" style="flex:1;height:28px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:4px;padding:0 8px;font-size:12px">\n          <button id="jsie-gf-custom-btn" class="jsie-btn-text" style="height:28px;padding:0 12px;font-size:11px">${r("fonts.load")}</button>\n        </div>\n        ${this._loadedGoogleFonts.size>0?`<div style="font-size:10px;color:var(--jsie-text2);margin-bottom:4px">${r("fonts.loaded")}</div>\n        <div id="jsie-gf-loaded" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--jsie-border)"></div>`:""}\n        <div style="font-size:10px;color:var(--jsie-text2);margin-bottom:4px">${r("fonts.popular")}</div>\n        <div id="jsie-gf-list" style="flex:1;overflow-y:auto;display:flex;flex-wrap:wrap;gap:4px;align-content:flex-start"></div>\n        <div style="display:flex;justify-content:flex-end;margin-top:12px">\n          <button id="jsie-gf-close" class="jsie-btn-text secondary" style="height:28px;padding:0 16px;font-size:11px">Cancel</button>\n        </div>`,t.appendChild(i),this.root.appendChild(t);const o=i.querySelector("#jsie-gf-search"),a=i.querySelector("#jsie-gf-list"),n=i.querySelector("#jsie-gf-loaded"),l=i.querySelector("#jsie-gf-custom"),c=i.querySelector("#jsie-gf-custom-btn"),h=(e,t)=>{const i=document.createElement("button");return i.className="jsie-gf-chip"+(t?" loaded":""),i.textContent=e,t&&(i.style.fontFamily=`'${e}', sans-serif`),i.onclick=()=>p(e,i),i},d=t=>{a.innerHTML="";const i=(t||"").toLowerCase();e.filter(e=>!i||e.toLowerCase().includes(i)).forEach(e=>{a.appendChild(h(e,this._loadedGoogleFonts.has(e)))})},p=async(e,t)=>{if(this._loadedGoogleFonts.has(e))return this.fontFamily=e,this._syncTextLayerProps(),this._redraw(),this._addFontToDropdown(e),void g();t.textContent=r("fonts.loading"),t.disabled=!0;try{await this._loadGoogleFont(e),this.fontFamily=e,this._syncTextLayerProps(),this._redraw(),this._addFontToDropdown(e),g()}catch(i){t.textContent=e+" ✗",t.disabled=!1}},u=async()=>{const e=l.value.trim();if(e){c.textContent=r("fonts.loading"),c.disabled=!0;try{await this._loadGoogleFont(e),this.fontFamily=e,this._syncTextLayerProps(),this._redraw(),this._addFontToDropdown(e),g()}catch(e){c.textContent=r("fonts.load")+" ✗",c.disabled=!1,setTimeout(()=>{c.textContent=r("fonts.load")},2e3)}}};s(o,"input",()=>d(o.value)),s(c,"click",u),s(l,"keydown",e=>{"Enter"===e.key&&u()});const g=()=>{t.remove(),this._renderToolOptions()};s(i.querySelector("#jsie-gf-close"),"click",g),s(t,"click",e=>{e.target===t&&g()}),d(""),n&&(()=>{n&&(n.innerHTML="",this._loadedGoogleFonts.forEach(e=>{n.appendChild(h(e,!0))}))})(),requestAnimationFrame(()=>{a.querySelectorAll(".jsie-gf-chip.loaded").forEach(e=>{e.style.fontFamily=`'${e.textContent}', sans-serif`})}),o.focus()}_addFontToDropdown(e){const i=t("#jsie-opt-font",this.root);if(!i)return;if(!Array.from(i.options).some(t=>t.value===e)){const t=document.createElement("option");t.value=e,t.textContent=e,i.insertBefore(t,i.firstChild)}i.value=e}_webColors(){return["#000000","#333333","#555555","#777777","#999999","#bbbbbb","#dddddd","#ffffff","#ff0000","#ff4444","#ff6600","#ff9900","#ffcc00","#ffff00","#ccff00","#66ff00","#00ff00","#00ff66","#00ffcc","#00ffff","#00ccff","#0099ff","#0066ff","#0000ff","#6600ff","#9900ff","#cc00ff","#ff00ff","#ff0099","#ff0066","#ff3366","#ff6699","#990000","#994400","#996600","#999900","#669900","#009900","#009966","#009999","#006699","#003399","#000099","#330099","#660099","#990099","#990066","#993333","#ffcccc","#ffe0cc","#ffffcc","#ccffcc","#ccffe0","#ccffff","#cce0ff","#ccccff","#e0ccff","#ffccff","#ffcce0","#ffd7b5"]}_colorInputHtml(e,t){return`<span class="jsie-color-combo"><input type="color" id="${e}" value="${t}"><input type="text" class="jsie-hex-input" data-for="${e}" value="${t}" maxlength="7" spellcheck="false"><button type="button" class="jsie-palette-btn" data-for="${e}" title="Palette">▦</button></span>`}_showColorPalette(e,i){const o=this.root.querySelector(".jsie-color-palette");o&&o.remove();const a=document.createElement("div");a.className="jsie-color-palette";this._webColors().forEach(e=>{const t=document.createElement("span");t.className="jsie-swatch",t.style.background=e,t.dataset.color=e,t.title=e,a.appendChild(t)});const r=document.createElement("div");r.style.cssText="display:flex;gap:4px;padding:4px 0 0;border-top:1px solid var(--jsie-border);margin-top:4px",r.innerHTML='<input type="text" class="jsie-palette-custom" placeholder="#ffcc00" maxlength="7" spellcheck="false" style="flex:1;height:22px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 6px;font-size:11px;font-family:monospace">',a.appendChild(r);const n=r.querySelector("input"),l=i.getBoundingClientRect(),c=this.root.getBoundingClientRect();a.style.top=l.bottom-c.top+4+"px",a.style.left=Math.min(l.left-c.left,c.width-220)+"px",this.root.appendChild(a);const h=i=>{const s=t(`#${e}`,this.root),o=t(`.jsie-hex-input[data-for="${e}"]`,this.root);s&&(s.value=i,s.dispatchEvent(new Event("input",{bubbles:!0}))),o&&(o.value=i),a.remove()};s(a,"click",e=>{const t=e.target.closest(".jsie-swatch");t&&h(t.dataset.color)}),s(n,"keydown",e=>{if("Enter"===e.key){let e=n.value.trim();e&&!e.startsWith("#")&&(e="#"+e),/^#[0-9a-fA-F]{3,6}$/.test(e)&&h(e)}});const d=e=>{a.contains(e.target)||e.target===i||(a.remove(),document.removeEventListener("mousedown",d))};setTimeout(()=>document.addEventListener("mousedown",d),0)}_bindColorCombos(){i(".jsie-color-combo",this.root).forEach(e=>{const t=e.querySelector('input[type="color"]'),i=e.querySelector(".jsie-hex-input"),o=e.querySelector(".jsie-palette-btn");t&&i&&(s(t,"input",()=>{i.value=t.value}),s(i,"input",()=>{let e=i.value.trim();e&&!e.startsWith("#")&&(e="#"+e),/^#[0-9a-fA-F]{6}$/.test(e)&&(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})))})),o&&s(o,"click",()=>this._showColorPalette(o.dataset.for,o))})}_getMenuDefinition(){const e=/Mac/.test(navigator.platform)?"⌘":"Ctrl";return{file:[{label:r("btn.import"),icon:n.importImg,action:"import"},{label:r("btn.export"),icon:n.download,action:"export"},{type:"separator"},{label:r("menu.openProject"),action:"openProject"},{label:r("menu.saveProject"),action:"saveProject"},{type:"separator"},{label:r("btn.reset"),icon:n.reset,action:"reset"},{type:"separator"},{label:r("btn.save"),icon:n.save,action:"save"},{label:r("btn.cancel"),icon:n.cancel,action:"cancel"}],edit:[{label:r("tool.undo"),icon:n.undo,action:"undo",shortcut:`${e}+Z`},{label:r("tool.redo"),icon:n.redo,action:"redo",shortcut:`${e}+Y`},{type:"separator"},{label:r("menu.cut"),action:"cut",shortcut:`${e}+X`},{label:r("menu.copy"),action:"copy",shortcut:`${e}+C`},{label:r("menu.paste"),action:"paste",shortcut:`${e}+V`},{label:r("menu.delete"),action:"deletesel",shortcut:"Del"},{type:"separator"},{label:r("sel.all"),action:"selectAll",shortcut:`${e}+A`}],image:[{label:r("tool.resize"),icon:n.resize,action:"resize"},{label:r("tool.crop"),icon:n.crop,tool:"crop"},{type:"separator"},{label:r("tool.rotateLeft"),icon:n.rotateLeft,action:"rotateLeft"},{label:r("tool.rotateRight"),icon:n.rotateRight,action:"rotateRight"},{label:r("tool.flipH"),icon:n.flipH,action:"flipH"},{label:r("tool.flipV"),icon:n.flipV,action:"flipV"},{type:"separator"},{label:r("menu.filters"),submenu:"filters"}],layer:[{label:r("menu.newLayer"),icon:n.layerAdd,action:"addLayer"},{label:r("menu.duplicateLayer"),icon:n.layerDup,action:"dupLayer"},{label:r("menu.deleteLayer"),icon:n.layerDelete,action:"delLayer"},{type:"separator"},{label:r("menu.newGroup"),icon:n.folder,action:"addGroup"},{type:"separator"},{label:r("menu.layerStyles"),icon:n.layerStyles,action:"layerStyles"},{label:r("menu.resizeLayer"),action:"resizeLayer"}],select:[{label:r("sel.all"),action:"selectAll",shortcut:`${e}+A`},{label:r("sel.deselect"),action:"deselect",shortcut:`${e}+D`},{label:r("sel.invert"),action:"invertSel",shortcut:`${e}+Shift+I`},{type:"separator"},{label:r("sel.cropToSel"),action:"cropToSel"},{label:r("sel.delete"),action:"deleteSel",shortcut:"Del"}],view:[{label:r("tool.zoomIn"),icon:n.zoomIn,action:"zoomIn",shortcut:"+"},{label:r("tool.zoomOut"),icon:n.zoomOut,action:"zoomOut",shortcut:"-"},{label:r("tool.zoomFit"),icon:n.zoomFit,action:"zoomFit"},{type:"separator"},{label:r("menu.panels"),submenu:"panels"}],help:[{label:r("menu.shortcuts"),action:"showShortcuts"},{type:"separator"},{label:r("menu.about"),action:"showAbout"}],filters:(this.config.filters||["brightness","contrast","saturation","blur","grayscale","sepia","hue"]).map(e=>({label:r("filter."+e),action:"showFilter",param:e})),panels:[{label:r("menu.showLayers"),action:"toggleLayers",check:!0},{label:r("menu.showFilters"),action:"toggleFilters",check:!0},{label:r("menu.showStatusBar"),action:"toggleStatusBar",check:!0}]}}_buildMenuDropdown(e){const t=this._getMenuDefinition()[e];if(!t)return"";let i="";for(const e of t){if("separator"===e.type){i+='<div class="jsie-menu-separator"></div>';continue}if(e.submenu){i+=`<div class="jsie-menu-entry jsie-menu-has-sub" data-submenu="${e.submenu}">\n            <span class="jsie-menu-entry-icon"></span>\n            <span class="jsie-menu-entry-label">${e.label}</span>\n            <span class="jsie-menu-sub-arrow">▶</span>\n          </div>`;continue}const t=e.icon?`<span class="jsie-menu-entry-icon">${e.icon}</span>`:void 0!==e.check?`<span class="jsie-menu-check" data-check="${e.action}"></span>`:'<span class="jsie-menu-entry-icon"></span>',s=e.shortcut?`<span class="jsie-menu-shortcut">${e.shortcut}</span>`:"";i+=`<div class="jsie-menu-entry" ${e.action?`data-maction="${e.action}"`:""} ${e.tool?`data-mtool="${e.tool}"`:""} ${e.param?`data-mparam="${e.param}"`:""}>\n          ${t}\n          <span class="jsie-menu-entry-label">${e.label}</span>\n          ${s}\n        </div>`}return i}_openMenu(e,t){this._closeMenus();const i=document.createElement("div");i.className="jsie-menu-dropdown",i.dataset.menuDropdown=e,i.innerHTML=this._buildMenuDropdown(e),t.classList.add("open"),t.appendChild(i),this._menuOpen=e,this._updateMenuChecks(i);i.getBoundingClientRect().right>window.innerWidth&&(i.style.left="auto",i.style.right="0")}_closeMenus(){this.root&&(i(".jsie-menu-dropdown",this.root).forEach(e=>e.remove()),i(".jsie-menu-submenu",this.root).forEach(e=>e.remove()),i(".jsie-menu-item.open",this.root).forEach(e=>e.classList.remove("open")),this._menuOpen=null)}_updateMenuChecks(e){const s=i("[data-check]",e);for(const e of s){const i=e.dataset.check;let s=!1;if("toggleLayers"===i){const e=t("#jsie-layers-panel",this.root);s=e&&"none"!==e.style.display}else if("toggleFilters"===i){const e=t('[data-rpanel="image"]',this.root);s=e&&e.classList.contains("active")}else if("toggleStatusBar"===i){const e=t(".jsie-status-bar",this.root);s=e&&"none"!==e.style.display}e.textContent=s?"✓":""}}_handleMenuAction(e,i){switch(this._closeMenus(),e){case"import":this._triggerImport();break;case"export":this._showExportDialog();break;case"openProject":this._triggerOpenProject();break;case"saveProject":this.saveProject();break;case"reset":this.reset();break;case"save":this._onSave();break;case"cancel":this._onCancel();break;case"undo":this.undo();break;case"redo":this.redo();break;case"cut":this._cutSelection();break;case"copy":this._copySelection();break;case"paste":this._pasteSelection();break;case"deletesel":case"deleteSel":this._deleteSelection();break;case"selectAll":this._selectAll();break;case"resize":this.showResizePanel();break;case"rotateLeft":this.rotate(-90);break;case"rotateRight":this.rotate(90);break;case"flipH":this.flip("horizontal");break;case"flipV":this.flip("vertical");break;case"addLayer":this.layerManager&&this.layerManager.addLayer("Layer"),this._redraw();break;case"dupLayer":this.layerManager&&this.layerManager.duplicateLayer(this.layerManager.activeLayerId),this._redraw();break;case"delLayer":this.layerManager&&this.layerManager.deleteLayer(this.layerManager.activeLayerId),this._redraw();break;case"addGroup":this.layerManager&&this.layerManager.addGroup("Group"),this._redraw();break;case"layerStyles":this._showLayerStylesDialog();break;case"resizeLayer":if(this.layerManager){const e=this.layerManager.getActive();e&&this._showResizeLayerDialog(e)}break;case"deselect":this._clearSelection();break;case"invertSel":this._invertSelection();break;case"cropToSel":this._cropToSelection();break;case"zoomIn":this._zoom(1.25);break;case"zoomOut":this._zoom(.8);break;case"zoomFit":this._zoomFit();break;case"toggleLayers":{const e=t("#jsie-layers-panel",this.root);e&&(e.style.display="none"===e.style.display?"":"none");break}case"toggleFilters":{const e=t('[data-rpanel="image"]',this.root);e&&e.click();break}case"toggleStatusBar":{const e=t(".jsie-status-bar",this.root);e&&(e.style.display="none"===e.style.display?"":"none");break}case"showFilter":{const e=t('[data-rpanel="image"]',this.root);if(e&&!e.classList.contains("active")&&e.click(),i){const e=t(`input[data-filter="${i}"]`,this.root);e&&e.focus()}break}case"showShortcuts":this._showShortcutsDialog();break;case"showAbout":this._showAboutDialog()}}_showShortcutsDialog(){const e=/Mac/.test(navigator.platform)?"⌘":"Ctrl",t=[[r("tool.undo"),`${e}+Z`],[r("tool.redo"),`${e}+Y`],[r("sel.all"),`${e}+A`],[r("sel.deselect"),`${e}+D`],[r("sel.invert"),`${e}+Shift+I`],[r("menu.cut"),`${e}+X`],[r("menu.copy"),`${e}+C`],[r("menu.paste"),`${e}+V`],[r("menu.delete"),"Del / Backspace"],[r("tool.zoomIn"),"+ / Wheel up"],[r("tool.zoomOut"),"- / Wheel down"],[r("tool.zoomFit"),`${e}+0`]].map(([e,t])=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--jsie-border)">\n          <span>${e}</span><span style="color:var(--jsie-text2)">${t}</span>\n        </div>`).join(""),i=document.createElement("div");i.className="jsie-modal-overlay",i.style.cssText="position:absolute;inset:0;background:rgba(0,0,0,.5);z-index:10010;display:flex;align-items:center;justify-content:center",i.innerHTML=`<div style="background:var(--jsie-bg2);border:1px solid var(--jsie-border);border-radius:8px;padding:20px;min-width:320px;max-width:400px;box-shadow:0 8px 30px rgba(0,0,0,.4)">\n        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">\n          <strong style="font-size:14px">${r("menu.shortcuts")}</strong>\n          <button class="jsie-btn jsie-modal-close" style="width:24px;height:24px">${n.cancel}</button>\n        </div>\n        <div style="font-size:12px">${t}</div>\n      </div>`,i.addEventListener("click",e=>{(e.target===i||e.target.closest(".jsie-modal-close"))&&i.remove()}),this.root.appendChild(i)}_showAboutDialog(){const e=document.createElement("div");e.className="jsie-modal-overlay",e.style.cssText="position:absolute;inset:0;background:rgba(0,0,0,.5);z-index:10010;display:flex;align-items:center;justify-content:center",e.innerHTML='<div style="background:var(--jsie-bg2);border:1px solid var(--jsie-border);border-radius:8px;padding:24px;min-width:280px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.4)">\n        <div style="font-size:24px;font-weight:700;margin-bottom:4px;color:var(--jsie-accent)">Shou Editor</div>\n        <div style="font-size:12px;color:var(--jsie-text2);margin-bottom:12px">Image Editor</div>\n        <div style="font-size:11px;color:var(--jsie-text2);margin-bottom:16px">Vanilla JavaScript ES6+ — Zero Dependencies</div>\n        <button class="jsie-btn-text jsie-modal-close" style="margin:0 auto">OK</button>\n      </div>',e.addEventListener("click",t=>{(t.target===e||t.target.closest(".jsie-modal-close"))&&e.remove()}),this.root.appendChild(e)}saveProject(){if(!this.layerManager)return;const e={format:"shoimg",version:1,timestamp:Date.now(),layerManager:this.layerManager.serializeForProject(),filters:{...this.filters},zoom:this.zoom||1,theme:this.config.theme||"dark"},t=JSON.stringify(e),i=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download=(this._projectName||"project")+".shoimg",o.click(),URL.revokeObjectURL(s)}async openProject(e){const i=await e.text();let s;try{s=JSON.parse(i)}catch(e){return void console.error("Invalid .shoimg file")}if(!s.format||"shoimg"!==s.format||!s.layerManager)return void console.error("Not a valid .shoimg project file");this._projectName=e.name.replace(/\.shoimg$/i,""),s.filters&&(this.filters={...this.filters,...s.filters},this._resetFilterSliders()),await this.layerManager.restoreFromProject(s.layerManager),this._setupCanvas(this.layerManager.docWidth,this.layerManager.docHeight);const o=t("#jsie-canvas-wrap",this.root),a=t("#jsie-empty",this.root);o&&(o.style.display=""),a&&(a.style.display="none"),this._applyFilters(),this._redraw(),this._renderLayersList(),this._updateLayerOpacityUI(),this._updateStatusDims(),this.history=[],this.historyIndex=-1,this.pushHistory()}_triggerOpenProject(){const e=document.createElement("input");e.type="file",e.accept=".shoimg",e.addEventListener("change",()=>{e.files&&e.files[0]&&this.openProject(e.files[0])}),e.click()}_showExportDialog(){if(!this.layerManager)return;const e=this.layerManager,t=document.createElement("div");t.className="jsie-modal-overlay",t.style.zIndex="10001";const i=document.createElement("div");i.style.cssText="background:var(--jsie-bg);padding:24px;border-radius:8px;width:380px;max-width:90vw;color:var(--jsie-text)",i.innerHTML=`\n        <h3 style="margin:0 0 20px;font-size:16px">${r("export.title")}</h3>\n        <div style="margin-bottom:14px">\n          <label style="display:block;margin-bottom:4px;color:var(--jsie-text2);font-size:12px">${r("export.format")}</label>\n          <select id="jsie-exp-fmt" style="width:100%;height:30px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:4px;padding:0 8px;font-size:13px">\n            <option value="png">PNG</option>\n            <option value="jpeg">JPEG</option>\n            <option value="webp">WebP</option>\n          </select>\n        </div>\n        <div id="jsie-exp-qrow" style="margin-bottom:14px;display:none">\n          <label style="display:block;margin-bottom:4px;color:var(--jsie-text2);font-size:12px">${r("export.quality")}: <span id="jsie-exp-qval">92</span>%</label>\n          <input type="range" id="jsie-exp-quality" min="1" max="100" value="92" style="width:100%">\n        </div>\n        <div style="margin-bottom:20px;padding:12px;background:var(--jsie-bg2);border-radius:4px;font-size:12px">\n          <div style="display:flex;justify-content:space-between;margin-bottom:4px">\n            <span style="color:var(--jsie-text2)">${r("export.dimensions")}</span>\n            <span>${e.docWidth} × ${e.docHeight}</span>\n          </div>\n          <div style="display:flex;justify-content:space-between">\n            <span style="color:var(--jsie-text2)">${r("export.fileSize")}</span>\n            <span id="jsie-exp-size">…</span>\n          </div>\n        </div>\n        <div style="display:flex;gap:8px;justify-content:flex-end">\n          <button class="jsie-btn-text secondary" id="jsie-exp-cancel">${r("btn.cancel")}</button>\n          <button class="jsie-btn-text" id="jsie-exp-dl">${n.download} ${r("export.download")}</button>\n        </div>\n      `,t.appendChild(i),this.root.appendChild(t);const s=i.querySelector("#jsie-exp-fmt"),o=i.querySelector("#jsie-exp-qrow"),a=i.querySelector("#jsie-exp-quality"),l=i.querySelector("#jsie-exp-qval"),c=i.querySelector("#jsie-exp-size"),h=()=>{const e=s.value,t=parseInt(a.value)/100;o.style.display="png"===e?"none":"block",c.textContent="…";const i="jpeg"===e?"image/jpeg":"webp"===e?"image/webp":"image/png";this._flatten().toBlob(e=>{if(e){const t=(e.size/1024).toFixed(1),i=(e.size/1048576).toFixed(2);c.textContent=e.size>1048576?i+" MB":t+" KB"}},i,t)};s.addEventListener("change",h),a.addEventListener("input",()=>{l.textContent=a.value,h()}),i.querySelector("#jsie-exp-cancel").addEventListener("click",()=>t.remove()),t.addEventListener("click",e=>{e.target===t&&t.remove()}),i.querySelector("#jsie-exp-dl").addEventListener("click",()=>{const e=s.value,i=parseInt(a.value)/100,o="jpeg"===e?"image/jpeg":"webp"===e?"image/webp":"image/png";this._flatten().toBlob(i=>{if(i){const s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download=`image-${Date.now()}.${"jpeg"===e?"jpg":e}`,o.click(),URL.revokeObjectURL(s),t.remove()}},o,i)}),h()}_showResizeLayerDialog(e){if(!e||"group"===e.type)return;const t=this._getLayerContentBounds(e);if(!t)return;const i=t.width,s=t.height,o=i/s,a=document.createElement("div");a.className="jsie-modal-overlay",a.style.zIndex="10001";const n=document.createElement("div");n.style.cssText="background:var(--jsie-bg);padding:20px;border-radius:8px;width:300px;max-width:90vw;color:var(--jsie-text)",n.innerHTML=`\n        <h3 style="margin:0 0 16px;font-size:15px">${r("layer.resize")}: ${e.name}</h3>\n        <div style="margin-bottom:8px;font-size:11px;color:var(--jsie-text2)">Current: ${i} × ${s}px</div>\n        <div class="jsie-row" style="display:flex;gap:8px;align-items:center;margin-bottom:8px">\n          <label style="font-size:12px;min-width:44px">${r("opt.width")}</label>\n          <input type="number" id="jsie-rlw" value="${i}" min="1" max="9999" style="width:80px;height:28px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 6px;font-size:12px">\n        </div>\n        <div class="jsie-row" style="display:flex;gap:8px;align-items:center;margin-bottom:10px">\n          <label style="font-size:12px;min-width:44px">${r("opt.height")}</label>\n          <input type="number" id="jsie-rlh" value="${s}" min="1" max="9999" style="width:80px;height:28px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 6px;font-size:12px">\n        </div>\n        <div style="display:flex;align-items:center;gap:6px;margin-bottom:16px">\n          <input type="checkbox" id="jsie-rl-lock" checked><label for="jsie-rl-lock" style="font-size:12px">${r("opt.lockRatio")}</label>\n        </div>\n        <div style="display:flex;gap:8px;justify-content:flex-end">\n          <button class="jsie-btn-text secondary" id="jsie-rl-cancel">${r("btn.cancel")}</button>\n          <button class="jsie-btn-text" id="jsie-rl-apply">${r("btn.apply")}</button>\n        </div>\n      `,a.appendChild(n),this.root.appendChild(a);const l=n.querySelector("#jsie-rlw"),c=n.querySelector("#jsie-rlh"),h=n.querySelector("#jsie-rl-lock");l.addEventListener("input",()=>{h.checked&&(c.value=Math.round(parseInt(l.value)/o)||1)}),c.addEventListener("input",()=>{h.checked&&(l.value=Math.round(parseInt(c.value)*o)||1)}),n.querySelector("#jsie-rl-cancel").addEventListener("click",()=>a.remove()),a.addEventListener("click",e=>{e.target===a&&a.remove()}),n.querySelector("#jsie-rl-apply").addEventListener("click",()=>{const o=parseInt(l.value),r=parseInt(c.value);if(o>0&&r>0&&(o!==i||r!==s)){this.layerManager;const i=document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(e.canvas,t.x,t.y,t.width,t.height,0,0,t.width,t.height),e.ctx.clearRect(0,0,e.width,e.height);const s=t.x+t.width/2,a=t.y+t.height/2,n=Math.round(s-o/2),l=Math.round(a-r/2);e.ctx.drawImage(i,0,0,t.width,t.height,n,l,o,r),"text"===e.type&&e.textData&&(e.textData.x=n,e.textData.y=l),this.pushHistory(),this._redraw(),this._renderLayersList()}a.remove()})}_showLayerStylesDialog(){if(!this.layerManager||!this.layerManager.activeLayer)return;const e=this.layerManager.activeLayer;if("group"===e.type)return;e.effects.border||(e.effects.border={enabled:!1,size:2,color:"#000000",style:"solid",radius:0,opacity:1}),e.effects.gradientOverlay||(e.effects.gradientOverlay={enabled:!1,color1:"#000000",color2:"#ffffff",type:"linear",angle:0,opacity:.75});const t=JSON.parse(JSON.stringify(e.effects)),s=e.effects;let o="dropShadow";const a=document.createElement("div");a.className="jsie-modal-overlay",a.style.zIndex="10001";const n=document.createElement("div");n.style.cssText="background:var(--jsie-bg);border-radius:8px;width:560px;max-width:92vw;height:460px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;color:var(--jsie-text)";const l=document.createElement("div");l.style.cssText="padding:14px 18px;border-bottom:1px solid var(--jsie-border);font-size:15px;font-weight:600",l.textContent=r("layer.styles")+": "+e.name;const c=document.createElement("div");c.style.cssText="flex:1;display:flex;overflow:hidden";const h=[{key:"dropShadow",label:r("effect.dropShadow")},{key:"innerShadow",label:r("effect.innerShadow")},{key:"outerGlow",label:r("effect.outerGlow")},{key:"stroke",label:r("effect.stroke")},{key:"colorOverlay",label:r("effect.colorOverlay")},{key:"border",label:r("effect.border")},{key:"gradientOverlay",label:r("effect.gradientOverlay")}],d=document.createElement("div");d.style.cssText="width:170px;border-right:1px solid var(--jsie-border);overflow-y:auto;background:var(--jsie-bg2)",d.innerHTML=h.map(e=>`<div class="jsie-fx-item" data-fx="${e.key}" style="padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--jsie-border);font-size:12px">\n          <input type="checkbox" ${s[e.key].enabled?"checked":""} style="margin:0;cursor:pointer">\n          <span style="flex:1">${e.label}</span>\n        </div>`).join("");const p=document.createElement("div");p.style.cssText="flex:1;overflow-y:auto;padding:16px";const u=(e,t,i,s,o,a)=>`<div style="margin-bottom:10px">\n          <label style="display:block;margin-bottom:3px;color:var(--jsie-text2);font-size:11px">${e}: <span data-vl="${t}">${"opacity"===t?Math.round(100*i):i}</span>${"opacity"===t?"%":"px"}</label>\n          <input type="range" data-pr="${t}" min="${s}" max="${o}" step="${a||1}" value="${"opacity"===t?100*i:i}" style="width:100%">\n        </div>`,g=(e,t,i)=>`<div style="margin-bottom:10px">\n          <label style="display:block;margin-bottom:3px;color:var(--jsie-text2);font-size:11px">${e}</label>\n          <input type="color" data-pr="${t}" value="${i}" style="width:100%;height:30px;border:1px solid var(--jsie-border);border-radius:3px;cursor:pointer">\n        </div>`,y=(e,t,i,s)=>`<div style="margin-bottom:10px">\n          <label style="display:block;margin-bottom:3px;color:var(--jsie-text2);font-size:11px">${e}</label>\n          <select data-pr="${t}" style="width:100%;height:28px;background:var(--jsie-input-bg);border:1px solid var(--jsie-border);color:var(--jsie-text);border-radius:3px;padding:0 6px;font-size:12px">\n            ${i.map(e=>`<option value="${e.v}"${e.v===s?" selected":""}>${e.l}</option>`).join("")}\n          </select>\n        </div>`,f=e=>{o=e;const t=s[e];i(".jsie-fx-item",d).forEach(t=>t.style.background=t.dataset.fx===e?"var(--jsie-layer-active)":"");let a=`<h4 style="margin:0 0 14px;font-size:13px;font-weight:600">${h.find(t=>t.key===e).label}</h4>`;"dropShadow"===e||"innerShadow"===e?(a+=g(r("effect.color"),"color",t.color),a+=u(r("effect.opacity"),"opacity",t.opacity,0,100,1),a+=u(r("effect.offsetX"),"offsetX",t.offsetX,-50,50,1),a+=u(r("effect.offsetY"),"offsetY",t.offsetY,-50,50,1),a+=u(r("effect.blur"),"blur",t.blur,0,50,1)):"outerGlow"===e?(a+=g(r("effect.color"),"color",t.color),a+=u(r("effect.opacity"),"opacity",t.opacity,0,100,1),a+=u(r("effect.blur"),"blur",t.blur,0,50,1)):"stroke"===e?(a+=g(r("effect.color"),"color",t.color),a+=u(r("effect.size"),"size",t.size,1,20,1),a+=y(r("effect.position"),"position",[{v:"outside",l:"Outside"},{v:"center",l:"Center"},{v:"inside",l:"Inside"}],t.position)):"colorOverlay"===e?(a+=g(r("effect.color"),"color",t.color),a+=u(r("effect.opacity"),"opacity",t.opacity,0,100,1),a+=y(r("effect.blendMode"),"blendMode",[{v:"normal",l:"Normal"},{v:"multiply",l:"Multiply"},{v:"screen",l:"Screen"},{v:"overlay",l:"Overlay"}],t.blendMode)):"border"===e?(a+=g(r("effect.color"),"color",t.color),a+=u(r("effect.size"),"size",t.size,1,30,1),a+=u(r("effect.opacity"),"opacity",t.opacity,0,100,1),a+=u(r("effect.borderRadius"),"radius",t.radius,0,100,1),a+=y(r("effect.borderStyle"),"style",[{v:"solid",l:r("effect.solid")},{v:"dashed",l:r("effect.dashed")},{v:"dotted",l:r("effect.dotted")}],t.style)):"gradientOverlay"===e&&(a+=g(r("effect.color1"),"color1",t.color1),a+=g(r("effect.color2"),"color2",t.color2),a+=u(r("effect.opacity"),"opacity",t.opacity,0,100,1),a+=u(r("effect.gradientAngle"),"angle",t.angle,0,360,1),a+=y(r("effect.gradientType"),"type",[{v:"linear",l:r("effect.linear")},{v:"radial",l:r("effect.radial")}],t.type)),p.innerHTML=a,i("[data-pr]",p).forEach(t=>{t.addEventListener("input",()=>{const i=t.dataset.pr;let o=t.value;"opacity"===i?o=parseFloat(o)/100:["offsetX","offsetY","blur","size","radius","angle"].includes(i)&&(o=parseFloat(o)),s[e][i]=o;const a=p.querySelector(`[data-vl="${i}"]`);a&&(a.textContent="opacity"===i?Math.round(100*o):o),this._redraw()}),t.addEventListener("change",()=>this._redraw())})};d.addEventListener("click",e=>{const t=e.target.closest(".jsie-fx-item");t&&("checkbox"===e.target.type?(s[t.dataset.fx].enabled=e.target.checked,this._redraw()):f(t.dataset.fx))}),c.appendChild(d),c.appendChild(p);const v=document.createElement("div");v.style.cssText="padding:10px 18px;border-top:1px solid var(--jsie-border);display:flex;gap:8px;justify-content:flex-end",v.innerHTML=`<button class="jsie-btn-text secondary" id="jsie-ls-cancel">${r("btn.cancel")}</button><button class="jsie-btn-text" id="jsie-ls-ok">OK</button>`,n.appendChild(l),n.appendChild(c),n.appendChild(v),a.appendChild(n),this.root.appendChild(a),f("dropShadow"),v.querySelector("#jsie-ls-cancel").addEventListener("click",()=>{e.effects=t,this._redraw(),a.remove()}),v.querySelector("#jsie-ls-ok").addEventListener("click",()=>{this.pushHistory(),a.remove()}),a.addEventListener("click",i=>{i.target===a&&(e.effects=t,this._redraw(),a.remove())})}_onSave(){const e=this.getImage();this.config.onSave&&this.config.onSave(e)}_onCancel(){this.config.onCancel&&this.config.onCancel()}destroy(){this._keyHandler&&(document.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._closeGroupSubmenu&&(document.removeEventListener("click",this._closeGroupSubmenu),this._closeGroupSubmenu=null),this._closeMenuOnOutside&&(document.removeEventListener("mousedown",this._closeMenuOnOutside),this._closeMenuOnOutside=null),this._stopMarchingAnts(),this.root&&this.root.parentNode&&this.root.remove(),this.layerManager=null,this.history=[],this._clipboard=null}}const p={version:"3.0.0",ImageEditor:d,loadConfig:async(e="js/image-editor-config.json")=>d.loadConfig(e),init:(e,t)=>new d(e,t),open(e,t={}){const i=document.createElement("div");i.className="jsie-modal-overlay";const s=document.createElement("div");s.className="jsie-modal-content",i.appendChild(s),document.body.appendChild(i);const o=t.onSave,a=t.onCancel,r=new d(s,{...t,onSave:e=>{i.remove(),o&&o(e)},onCancel:()=>{i.remove(),a&&a()}});return e&&r.loadImage(e),r}};"undefined"!=typeof module&&module.exports?module.exports=p:e.JSImageEditor=p}(window);